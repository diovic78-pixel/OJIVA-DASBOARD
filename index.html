<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Trazabilidad de Descarga de Buques</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f4f6fa; margin: 0; color: #19324c;}
    header { background: #102842; color: white; padding: 1rem; display:flex; align-items: center; justify-content: space-between;}
    header img {height:44px; margin-right:15px; border-radius:6px; background:#fff;}
    h1 { margin: 0.5rem; }
    .user-info { display:flex; align-items:center; gap:1rem; color:white; font-size:0.95em;}
    .user-info button { background:#ff5858; padding:0.4rem 0.8rem; border:none; border-radius:5px; color:white; cursor:pointer;}
    .user-info button:hover { background:#cc4444;}
    .login-screen { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:flex; align-items:center; justify-content:center; z-index:9999;}
    .login-box { background:white; padding:2rem; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,0.3); max-width:400px; width:90%;}
    .login-box h2 { margin-top:0; color:#102842;}
    .login-box input { width:100%; padding:0.6rem; margin:0.5rem 0; border:1px solid #ccd2db; border-radius:7px; font-size:1em;}
    .login-box button { width:100%; padding:0.7rem; background:#28568d; color:white; border:none; border-radius:7px; font-size:1em; cursor:pointer; margin-top:0.5rem;}
    .login-box button:hover { background:#163357;}
    .container { max-width: 1180px; margin: 2rem auto; padding: 1rem; background: white; border-radius: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);}
    section { margin-bottom: 2rem;}
    .modulo { padding: 1.2rem 1rem; margin-bottom: 2rem; border: 1px solid #dbe3eb; border-radius: 12px; background: #f9fbfd;}
    label { font-weight: 500; }
    input, select, button, textarea { margin-top: 0.2rem; margin-bottom: 0.6rem; padding: 0.4rem; border-radius: 7px; border: 1px solid #ccd2db;}
    button { background: #28568d; color: #fff; cursor: pointer; border: none; transition: background 0.2s;}
    button:hover { background: #163357;}
    table { width: 100%; border-collapse: collapse; margin-top: 1rem;}
    th, td { border: 1px solid #c7d3e6; padding: 0.6rem; text-align: left;}
    th { background: #e7f0fa;}
    .flex-row { display: flex; gap: 1.5rem; flex-wrap: wrap;}
    .flex-col-2 { flex: 1 1 310px;}
    .summary { margin-top: 1rem; background: #e1eaf6; padding: 1rem; border-radius: 8px;}
    .dashboard-card { background: #e6eef7; margin: 0.5rem; border-radius: 7px; padding: 1rem;}
    .status-badge { padding: 0.2em 0.7em; border-radius: 6px; color: #fff; font-size: 0.96em;}
    .cargado { background: #13ae60;}
    .no-cargado {background: #ff5858;}
    input[type="file"] {border:none;}
    .export-btn { background:#13ae60; margin-right:0.5rem;}
    .export-btn:hover { background:#0f8a4d;}
    @media (max-width: 760px) {
      .container {padding: 0.3rem;}
      .flex-row {flex-direction: column;}
      th, td { font-size:0.98em;}
    }
  </style>
</head>
<body>
<!-- LOGIN SCREEN -->
<div class="login-screen" id="login-screen">
  <div class="login-box">
    <h2>Iniciar Sesi√≥n</h2>
    <p>Ingresa tu nombre para acceder al panel</p>
    <input type="text" id="login-username" placeholder="Tu nombre" autofocus />
    <button onclick="login()">Entrar</button>
  </div>
</div>

<header>
  <div style="display:flex;align-items:center;">
    <img src="image.jpg" alt="Logo" />
    <h1>Panel de Trazabilidad de Descarga de Buques</h1>
  </div>
  <div class="user-info">
    <span>Usuario: <strong id="current-user"></strong></span>
    <button onclick="logout()">Cerrar Sesi√≥n</button>
  </div>
</header>
<div class="container">
  <div style="margin-bottom:1rem;">
    <button class="export-btn" onclick="exportarExcel()">üì• Exportar Todo a Excel</button>
    <button onclick="guardarDatos()">üíæ Guardar Datos</button>
  </div>

  <section class="modulo" id="mod-info-general">
    <h2>Informaci√≥n General del Buque</h2>
    <div class="flex-row">
      <div class="flex-col-2"><label>Nombre:</label><input id="buque-nombre"></div>
      <div class="flex-col-2"><label>ETA (Fecha estimada):</label><input type="datetime-local" id="buque-eta"></div>
      <div class="flex-col-2"><label>Fecha de NOR:</label><input type="datetime-local" id="buque-nor"></div>
      <div class="flex-col-2"><label>Rata Contratada TM/d√≠a:</label><input type="number" id="buque-rata" min="1"></div>
    </div>
    <div class="flex-row">
      <div class="flex-col-2">
        <label>Condici√≥n Contrato:</label>
        <select id="buque-condicion">
          <option value="SHINC">SHINC</option>
          <option value="SHEX">SHEX</option>
        </select>
      </div>
      <div class="flex-col-2"><label>Cantidad total de producto (TM):</label><input type="number" id="buque-tm" min="0"></div>
      <div class="flex-col-2"><label>Inicio de Operaciones:</label><input type="datetime-local" id="inicio-op"></div>
      <div class="flex-col-2"><label>Fin de Operaciones:</label><input type="datetime-local" id="fin-op"></div>
    </div>
    <div class="summary">
      <div><b>Laytime Disponible</b>: <span id="laytime"></span></div>
      <div><b>Tiempo en Operaci√≥n</b>: <span id="tiempo-operacion"></span></div>
    </div>
  </section>

  <section class="modulo">
    <h2>Productos Manifestados</h2>
    <div style="margin-bottom:1rem;">
      <label>Agregar Producto:</label>
      <div class="flex-row">
        <select id="nuevo-producto-tipo">
          <option value="">Seleccione producto...</option>
          <option value="Maiz Americano">Maiz Americano</option>
          <option value="Maiz Argentino">Maiz Argentino</option>
          <option value="Maiz Brasileno">Maiz Brasileno</option>
          <option value="DNS">DNS</option>
          <option value="HRW">HRW</option>
          <option value="SRW">SRW</option>
          <option value="Frijol">Frijol</option>
          <option value="Cascarilla">Cascarilla</option>
          <option value="Aceite de Palma">Aceite de Palma</option>
          <option value="Palmite">Palmite</option>
        </select>
        <select id="nuevo-producto-bodega">
          <option value="">Seleccione bodega...</option>
          <option value="1">Bodega 1</option>
          <option value="2">Bodega 2</option>
          <option value="3">Bodega 3</option>
          <option value="4">Bodega 4</option>
          <option value="5">Bodega 5</option>
          <option value="6">Bodega 6</option>
        </select>
        <button onclick="agregarProducto()">Agregar</button>
      </div>
    </div>
    <table id="tabla-productos">
      <thead><tr><th>Tipo Producto</th><th>Bodega</th><th>Declarado (TM)</th><th>Descargado (TM)</th><th>Acci√≥n</th></tr></thead>
      <tbody id="tbody-productos"></tbody>
    </table>
  </section>

  <section class="modulo">
    <h2>Registro de Paradas / Incidentes</h2>
    <form onsubmit="registrarParada(event)">
      <div class="flex-row">
        <div class="flex-col-2">
          <label>Motivo:</label>
          <select required id="parada-motivo">
            <option value="">Elija‚Ä¶</option>
            <option value="LLUVIA">LLUVIA</option>
            <option value="NO CAMIONES">NO CAMIONES</option>
            <option value="MOVIMIENTO BARCO">MOVIMIENTO BARCO</option>
            <option value="MECANIZADO FALLA">MECANIZADO FALLA</option>
            <option value="BUQUE INTERNO FALLA">BUQUE INTERNO FALLA</option>
            <option value="OTROS">OTROS</option>
          </select>
        </div>
        <div class="flex-col-2">
          <label>Bodega afectada</label>
          <select id="bodega-afectada">
            <option value="1">Bodega 1</option>
            <option value="2">Bodega 2</option>
            <option value="3">Bodega 3</option>
            <option value="4">Bodega 4</option>
            <option value="5">Bodega 5</option>
            <option value="6">Bodega 6</option>
            <option value="Completo">Completo</option>
          </select>
        </div>
        <div class="flex-col-2"><label>Inicio (fecha-hora):</label><input required type="datetime-local" id="parada-inicio"></div>
        <div class="flex-col-2"><label>Fin (fecha-hora):</label><input required type="datetime-local" id="parada-fin"></div>
        <div class="flex-col-2" style="align-self: flex-end;"><button type="submit">Registrar</button></div>
      </div>
    </form>
    <table id="tabla-paradas">
      <thead><tr><th>Motivo</th><th>Bodega</th><th>Inicio</th><th>Fin</th><th>Duraci√≥n</th><th>Acci√≥n</th></tr></thead>
      <tbody id="tbody-paradas"></tbody>
    </table>
    <div class="summary"><b>Tiempo Total Paradas:</b> <span id="tiempo-paradas"></span></div>
  </section>

  <section class="modulo">
    <h2>Tracking de Camiones</h2>
    <form onsubmit="registrarCamion(event)">
      <div class="flex-row">
        <div class="flex-col-2"><label>No. Listado:</label><input required id="camion-nlistado" type="number" min="1"></div>
        <div class="flex-col-2"><label>Placa:</label><input required id="camion-placa"></div>
        <div class="flex-col-2"><label>Ficha:</label><input required id="camion-ficha"></div>
        <div class="flex-col-2">
          <label>Estatus:</label>
          <select id="camion-estatus">
            <option value="Cargado">Cargado</option>
            <option value="No Cargado">No Cargado</option>
          </select>
        </div>
        <div class="flex-col-2" style="align-self: flex-end;"><button type="submit">Registrar</button></div>
      </div>
    </form>
    <div style="margin-bottom:0.7em;">
      <label>Filtrar por Estatus:</label>
      <select onchange="filtrarCamiones()" id="filtro-estatus">
        <option value="Todos">Todos</option>
        <option value="Cargado">Cargado</option>
        <option value="No Cargado">No Cargado</option>
      </select>
    </div>
    <table id="tabla-camiones">
      <thead><tr><th>No. Listado</th><th>Placa</th><th>Ficha</th><th>Estatus</th><th>Acci√≥n</th></tr></thead>
      <tbody id="tbody-camiones"></tbody>
    </table>
    <div class="summary">
      <b>Camiones registrados:</b> <span id="camion-total"></span> |
      <b>Camiones por hora:</b> <span id="camion-xhora"></span>
    </div>
  </section>

  <section class="modulo">
    <h2>Correa Mecanizada</h2>
    <form onsubmit="registrarCorrea(event)">
      <div class="flex-row">
        <div class="flex-col-2">
          <label>L√≠nea:</label>
          <select id="correa-linea">
            <option value="1">L√≠nea 1</option>
            <option value="2">L√≠nea 2</option>
          </select>
        </div>
        <div class="flex-col-2"><label>Producto:</label><input required id="correa-producto"></div>
        <div class="flex-col-2"><label>Toneladas:</label><input required type="number" id="correa-tn" min="1"></div>
        <div class="flex-col-2"><label>Hora:</label><input required type="datetime-local" id="correa-hora"></div>
        <div class="flex-col-2" style="align-self: flex-end;"><button type="submit">Registrar</button></div>
      </div>
    </form>
    <table id="tabla-correa">
      <thead><tr><th>L√≠nea</th><th>Producto</th><th>Toneladas</th><th>Hora</th><th>Acci√≥n</th></tr></thead>
      <tbody id="tbody-correa"></tbody>
    </table>
    <div class="summary"><b>Total Descargado por Correa:</b> <span id="total-correa"></span> TM</div>
  </section>

  <section class="modulo">
    <h2>TONELADAS CAMIONES</h2>
    <input type="file" id="import-camiones" accept=".xlsx,.xls"/>
    <button onclick="limpiarTonCamiones()" type="button" style="background:#fff;color:#163357;border:1px solid #334;">Limpiar datos</button>
    <label style="display:block;margin:12px 0 0 0;">Toneladas mecanizado (+): <input id="toneladas-mec" type="number" min="0" value="0" style="width:90px;display:inline;" onchange="actualizarTotalToneladas()"></label>
    <div id="res-ton-camiones"></div>
    <canvas id="grafico-ton" height="120"></canvas>
  </section>

  <section class="modulo">
    <h2>Total Descargado</h2>
    <div class="summary" id="total-descargado"></div>
  </section>

  <section class="modulo">
    <h2>Dashboard y Resumen Ejecutivo</h2>
    <div class="dashboard-card"><b>Tiempo Bruto de Operaci√≥n:</b> <span id="dsh-tiempo-bruto">0.00 h</span></div>
    <div class="dashboard-card"><b>Tiempo Neto de Operaci√≥n:</b> <span id="dsh-tiempo-neto">0.00 h</span></div>
    <div class="dashboard-card"><b>TPH Promedio (bruto/neto):</b> <span id="dsh-tph">0.0 / 0.0 TM/h</span></div>
    <div class="dashboard-card"><b>Tiempo H√°bil Restante:</b> <span id="dsh-laytime-rest">0 horas</span></div>
    <div class="dashboard-card">
      <label>Gr√°fica de descarga por hora:</label>
      <canvas id="grafico-horas" height="120"></canvas>
    </div>
  </section>
</div>
<script>
// ==== SISTEMA DE USUARIOS Y LOG ====
let currentUser = '';
let activityLog = [];

function login() {
  const username = document.getElementById('login-username').value.trim();
  if(!username) {
    alert('Por favor ingresa tu nombre');
    return;
  }
  currentUser = username;
  localStorage.setItem('currentUser', currentUser);
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('current-user').innerText = currentUser;
  logActivity('Inicio de sesi√≥n');
  cargarDatos();
}

function logout() {
  logActivity('Cierre de sesi√≥n');
  guardarDatos();
  localStorage.removeItem('currentUser');
  currentUser = '';
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('login-username').value = '';
}

function logActivity(action, details='') {
  const timestamp = new Date().toLocaleString('es-DO');
  activityLog.push({user: currentUser, action, details, timestamp});
  localStorage.setItem('activityLog', JSON.stringify(activityLog));
}

// Verificar usuario al cargar
window.addEventListener('DOMContentLoaded', () => {
  const savedUser = localStorage.getItem('currentUser');
  if(savedUser) {
    currentUser = savedUser;
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('current-user').innerText = currentUser;
    cargarDatos();
  }
  const savedLog = localStorage.getItem('activityLog');
  if(savedLog) activityLog = JSON.parse(savedLog);
});

// ==== ESTADO Y VARIABLES ====
let productos = [], paradas=[], camiones=[], correa=[];
let laytimeHoras = 0;

// === GUARDAR/CARGAR DATOS ===
function guardarDatos() {
  const data = {
    buqueNombre: document.getElementById('buque-nombre').value,
    buqueEta: document.getElementById('buque-eta').value,
    buqueNor: document.getElementById('buque-nor').value,
    buqueRata: document.getElementById('buque-rata').value,
    buqueCondicion: document.getElementById('buque-condicion').value,
    buqueTm: document.getElementById('buque-tm').value,
    inicioOp: document.getElementById('inicio-op').value,
    finOp: document.getElementById('fin-op').value,
    productos, paradas, camiones, correa, activityLog
  };
  localStorage.setItem('trazabilidadData', JSON.stringify(data));
  logActivity('Guardado de datos');
  alert('Datos guardados correctamente');
}

function cargarDatos() {
  const saved = localStorage.getItem('trazabilidadData');
  if(!saved) return;
  const data = JSON.parse(saved);
  document.getElementById('buque-nombre').value = data.buqueNombre || '';
  document.getElementById('buque-eta').value = data.buqueEta || '';
  document.getElementById('buque-nor').value = data.buqueNor || '';
  document.getElementById('buque-rata').value = data.buqueRata || '';
  document.getElementById('buque-condicion').value = data.buqueCondicion || 'SHINC';
  document.getElementById('buque-tm').value = data.buqueTm || '';
  document.getElementById('inicio-op').value = data.inicioOp || '';
  document.getElementById('fin-op').value = data.finOp || '';
  productos = data.productos || [];
  paradas = data.paradas || [];
  camiones = data.camiones || [];
  correa = data.correa || [];
  renderProductos();
  renderParadas();
  renderCamiones();
  renderCorrea();
  calcLaytime();
  updateDashboard();
}

// === EXPORTAR A EXCEL ===
function exportarExcel() {
  const wb = XLSX.utils.book_new();
  // Hoja 1: Info General
  const wsGeneral = XLSX.utils.aoa_to_sheet([
    ['Informaci√≥n General del Buque'],
    ['Nombre', document.getElementById('buque-nombre').value],
    ['ETA', document.getElementById('buque-eta').value],
    ['Fecha NOR', document.getElementById('buque-nor').value],
    ['Rata TM/d√≠a', document.getElementById('buque-rata').value],
    ['Condici√≥n', document.getElementById('buque-condicion').value],
    ['Total TM', document.getElementById('buque-tm').value],
    ['Inicio Op.', document.getElementById('inicio-op').value],
    ['Fin Op.', document.getElementById('fin-op').value]
  ]);
  XLSX.utils.book_append_sheet(wb, wsGeneral, 'General');
  
  // Hoja 2: Productos
  const prodData = [['Producto','Bodega','Declarado','Descargado']];
  productos.forEach(p=>prodData.push([p.tipo,p.bodega,p.declarado,p.descargado]));
  const wsProd = XLSX.utils.aoa_to_sheet(prodData);
  XLSX.utils.book_append_sheet(wb, wsProd, 'Productos');
  
  // Hoja 3: Paradas
  const paradaData = [['Motivo','Bodega','Inicio','Fin']];
  paradas.forEach(p=>paradaData.push([p.motivo,p.bodega,p.ini,p.fin]));
  const wsParada = XLSX.utils.aoa_to_sheet(paradaData);
  XLSX.utils.book_append_sheet(wb, wsParada, 'Paradas');
  
  // Hoja 4: Camiones
  const camionData = [['Listado','Placa','Ficha','Estatus']];
  camiones.forEach(c=>camionData.push([c.nlist,c.placa,c.ficha,c.estatus]));
  const wsCamion = XLSX.utils.aoa_to_sheet(camionData);
  XLSX.utils.book_append_sheet(wb, wsCamion, 'Camiones');
  
  // Hoja 5: Correa
  const correaData = [['L√≠nea','Producto','Toneladas','Hora']];
  correa.forEach(c=>correaData.push([c.linea,c.prod,c.tn,c.hora]));
  const wsCorrea = XLSX.utils.aoa_to_sheet(correaData);
  XLSX.utils.book_append_sheet(wb, wsCorrea, 'Correa');
  
  // Hoja 6: Log de Actividad
  const logData = [['Usuario','Acci√≥n','Detalles','Fecha/Hora']];
  activityLog.forEach(l=>logData.push([l.user,l.action,l.details,l.timestamp]));
  const wsLog = XLSX.utils.aoa_to_sheet(logData);
  XLSX.utils.book_append_sheet(wb, wsLog, 'Log Actividad');
  
  XLSX.writeFile(wb, `Trazabilidad_${document.getElementById('buque-nombre').value||'Buque'}_${new Date().toISOString().split('T')[0]}.xlsx`);
  logActivity('Exportaci√≥n a Excel');
}

// --- LAYTIME Y OPERACION
function calcLaytime() {
  const tm=parseFloat(document.getElementById('buque-tm').value);
  const rata=parseFloat(document.getElementById('buque-rata').value);
  const condicion=document.getElementById('buque-condicion').value;
  if (tm>0 && rata>0) {
    let dias = tm/rata;
    if (condicion==='SHEX') dias *= (7/5);
    laytimeHoras = Math.round(dias*24);
    document.getElementById('laytime').innerText = laytimeHoras + " horas";
  } else {
    document.getElementById('laytime').innerText = "No definido";
  }
}
['buque-tm','buque-rata','buque-condicion'].forEach(id=>{
  document.getElementById(id).addEventListener('input',calcLaytime);
});

function calcOperacion() {
  const ini=document.getElementById('inicio-op').value;
  const fin=document.getElementById('fin-op').value;
  if (!ini) {document.getElementById('tiempo-operacion').innerText="No iniciado";return 0;}
  const dtIni = new Date(ini); let dtFin = fin? new Date(fin): new Date();
  let diff = Math.max((dtFin-dtIni)/3600000,0);
  document.getElementById('tiempo-operacion').innerText = (diff).toFixed(2) + " h"; 
  return diff;
}
['inicio-op','fin-op'].forEach(id=>{
  document.getElementById(id).addEventListener('input',()=>{ calcOperacion();updateDashboard(); });
});

// ---- PRODUCTOS
function renderProductos() {
  const tbody=document.getElementById('tbody-productos'); tbody.innerHTML="";
  productos.forEach((p,i)=>{
    tbody.innerHTML+=`<tr>
      <td>${p.tipo||""}</td>
      <td>${p.bodega||""}</td>
      <td><input type='number' min='0' style='width:70px' value='${p.declarado}' onchange='actProdDeclarado(${i}, this.value)'></td>
      <td><input type='number' min='0' style='width:70px' value='${p.descargado}' onchange='actProdDescargado(${i}, this.value)'></td>
      <td><button onclick="eliminaProducto(${i})">Eliminar</button></td>
    </tr>`;
  });
}
function actProdDeclarado(idx,vl){ productos[idx].declarado=Number(vl); renderProductos(); updateDashboard(); logActivity('Actualizar producto declarado', `Producto ${idx+1}: ${vl} TM`);}
function actProdDescargado(idx,vl){ productos[idx].descargado=Number(vl); renderProductos(); updateDashboard(); logActivity('Actualizar producto descargado', `Producto ${idx+1}: ${vl} TM`);}
function agregarProducto() { 
  const tipo = document.getElementById('nuevo-producto-tipo').value;
  const bodega = document.getElementById('nuevo-producto-bodega').value;
  if(!tipo || !bodega) {
    alert('Debe seleccionar producto y bodega');
    return;
  }
  productos.push({tipo,bodega,declarado:0,descargado:0}); 
  renderProductos();
  updateDashboard();
  logActivity('Agregar producto', `${tipo} en Bodega ${bodega}`);
}
function eliminaProducto(idx){ 
  logActivity('Eliminar producto', `${productos[idx].tipo}`);
  productos.splice(idx,1); 
  renderProductos(); 
  updateDashboard();
}

// ---- PARADAS
function registrarParada(e) {
  e.preventDefault();
  let motivo=document.getElementById('parada-motivo').value,
      bodega=document.getElementById('bodega-afectada').value,
      ini=document.getElementById('parada-inicio').value,
      fin=document.getElementById('parada-fin').value;
  paradas.push({motivo,bodega,ini,fin});
  renderParadas(); 
  updateDashboard();
  logActivity('Registrar parada', `${motivo} - Bodega ${bodega}`);
  e.target.reset();
}
function renderParadas() {
  const tbody=document.getElementById('tbody-paradas'); tbody.innerHTML="";
  paradas.forEach((p,i)=>{
    let duration="";
    if (p.ini && p.fin) {
      const d1=new Date(p.ini), d2=new Date(p.fin);
      let diff=(d2-d1)/3600000;
      duration=`${Math.floor(diff)}h ${Math.round((diff%1)*60)}m`;
    }
    tbody.innerHTML+=`<tr>
      <td>${p.motivo}</td>
      <td>${p.bodega}</td>
      <td>${p.ini.replace("T", " ")}</td>
      <td>${p.fin.replace("T", " ")}</td>
      <td>${duration}</td>
      <td><button onclick="eliminaParada(${i})">Eliminar</button></td>
    </tr>`;
  });
  let total=0;
  paradas.forEach(p=>{ if (p.ini&&p.fin) total+=((new Date(p.fin))-(new Date(p.ini)))/3600000; });
  document.getElementById('tiempo-paradas').innerText=total.toFixed(2)+' h';
}
function eliminaParada(idx){
  logActivity('Eliminar parada', `${paradas[idx].motivo}`);
  paradas.splice(idx,1);
  renderParadas();
  updateDashboard();
}

// ---- CAMIONES
function registrarCamion(e){
  e.preventDefault();
  let nlist=document.getElementById('camion-nlistado').value,
      placa=document.getElementById('camion-placa').value,
      ficha=document.getElementById('camion-ficha').value,
      estatus=document.getElementById('camion-estatus').value;
  if(camiones.find(c=>c.nlist===nlist&&(c.placa===placa||c.ficha===ficha))){
    alert('Ya existe esa ficha o placa en ese listado');
    return false;
  }
  camiones.push({nlist,placa,ficha,estatus});
  renderCamiones();
  logActivity('Registrar cami√≥n', `Placa ${placa} - Ficha ${ficha}`);
  e.target.reset();
}
function renderCamiones(){
  const tbody=document.getElementById('tbody-camiones'); tbody.innerHTML="";
  let filtro=document.getElementById('filtro-estatus').value;
  let visibles=camiones.filter(c=>filtro==="Todos"? true : c.estatus===filtro);
  visibles.forEach((c,i)=>{
    tbody.innerHTML+=`<tr>
      <td>${c.nlist}</td>
      <td>${c.placa}</td>
      <td>${c.ficha}</td>
      <td><span class="status-badge ${c.estatus==='Cargado'?'cargado':'no-cargado'}">${c.estatus}</span></td>
      <td><button onclick="eliminaCamion(${i})">Eliminar</button></td>
    </tr>`;
  });
  document.getElementById('camion-total').innerText=camiones.length;
  let operacionHoras = calcOperacion() || 1;
  document.getElementById('camion-xhora').innerText = (camiones.length / Math.max(operacionHoras/24,0.1)).toFixed(1);
}
function eliminaCamion(idx){ 
  logActivity('Eliminar cami√≥n', `Placa ${camiones[idx].placa}`);
  camiones.splice(idx,1);
  renderCamiones();
}
function filtrarCamiones(){renderCamiones();}

// ---- CORREA
function registrarCorrea(e){
  e.preventDefault();
  let linea=document.getElementById('correa-linea').value,
      prod=document.getElementById('correa-producto').value,
      tn=document.getElementById('correa-tn').value,
      hora=document.getElementById('correa-hora').value;
  correa.push({linea,prod,tn:Number(tn),hora});
  renderCorrea(); 
  updateDashboard();
  logActivity('Registrar correa', `L√≠nea ${linea} - ${tn} TM`);
  e.target.reset();
}
function renderCorrea(){
  const tbody=document.getElementById('tbody-correa'); tbody.innerHTML="";
  correa.forEach((c,i)=>{
    tbody.innerHTML+=`<tr>
      <td>${c.linea}</td><td>${c.prod}</td><td>${c.tn}</td><td>${c.hora.replace("T"," ")}</td>
      <td><button onclick="eliminaCorrea(${i})">Eliminar</button></td>
    </tr>`;
  });
  let total = correa.reduce((acc,c)=>acc+c.tn,0);
  document.getElementById('total-correa').innerText=total.toFixed(2);
}
function eliminaCorrea(idx){ 
  logActivity('Eliminar correa', `L√≠nea ${correa[idx].linea}`);
  correa.splice(idx,1);
  renderCorrea();
  updateDashboard();
}

// ---- TOTALES
function updateTotales() {
  let totalCamion = productos.reduce((a,p)=>a+p.descargado,0);
  let totalCorrea = correa.reduce((a,c)=>a+c.tn,0);
  document.getElementById('total-descargado').innerHTML =
    `<b>Total descargado cami√≥n:</b> ${totalCamion.toFixed(2)} TM <b>| Correa:</b> ${totalCorrea.toFixed(2)} TM <b>| Total:</b> ${(totalCamion+totalCorrea).toFixed(2)} TM`;
}

// ---- DASHBOARD
function updateDashboard(){
  let bruto=calcOperacion()||0;
  let tiempoParadas=0; 
  paradas.forEach(p=> {
    if (p.ini&&p.fin) tiempoParadas+=((new Date(p.fin))-(new Date(p.ini)))/3600000;
  });
  let neto = Math.max(bruto-tiempoParadas,0);
  document.getElementById('dsh-tiempo-bruto').innerText=bruto.toFixed(2) + " h";
  document.getElementById('dsh-tiempo-neto').innerText=neto.toFixed(2) + " h";
  let tot = productos.reduce((a,p)=>a+p.descargado,0) + correa.reduce((a,c)=>a+c.tn,0);
  let tphBruto = bruto > 0 ? (tot/bruto) : 0;
  let tphNeto  = neto  > 0 ? (tot/neto)  : 0;
  document.getElementById('dsh-tph').innerText=`${tphBruto.toFixed(1)} / ${tphNeto.toFixed(1)} TM/h`;
  let disponible = laytimeHoras-(bruto||0);
  document.getElementById('dsh-laytime-rest').innerText = (disponible>0?disponible.toFixed(2):'0')+' horas';
  updateTotales();
  updateGrafico();
}
setInterval(updateDashboard,30000);

// ---- GRAFICA
function updateGrafico(){
  let ctx=document.getElementById('grafico-horas').getContext('2d');
  ctx.clearRect(0,0,600,120);
  let horas = {};
  correa.forEach(c=>{
    let h=(c.hora||"").split("T")[1]? (c.hora.split("T")[1].substr(0,5)):"";
    if (!horas[h]) horas[h]=0;
    horas[h]+=c.tn;
  });
  let labels=Object.keys(horas); 
  let vals=labels.map(l=>horas[l]);
  if(labels.length===0) return;
  let maxV = Math.max(...vals,1);
  let W=ctx.canvas.width, H=ctx.canvas.height; 
  let step = labels.length>1? W/(labels.length-1): W/2;
  ctx.beginPath(); ctx.strokeStyle="#2355a4"; ctx.lineWidth=2;
  labels.forEach((h,i)=>{
    let x = i*step, y = H-(vals[i]/maxV*0.8*H)-18;
    if(i==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    ctx.arc(x, y, 2.3, 0, 2*Math.PI);
  }); 
  ctx.stroke();
  ctx.fillStyle="#333";
  ctx.font="10px Arial";
  labels.forEach((h,i)=> ctx.fillText(h, i*step-10, H-2));
  ctx.fillStyle="#237acf";
  labels.forEach((h,i)=> ctx.fillRect(i*step-2, H-(vals[i]/maxV*0.8*H)-8,4,8));
}

// ===== TON CAMIONES =====
let dataImport = [], dataResumen = {}, horas = [];
document.getElementById('import-camiones').addEventListener('change', function(evt){
  const file = evt.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    const workbook = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
    const name = workbook.SheetNames[0];
    const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[name], {header:1,defval:""});
    procesarTonCamiones(sheet);
  };
  reader.readAsArrayBuffer(file);
});

function procesarTonCamiones(sheet){
  let headerIdx = sheet.findIndex(row =>
    row.includes("Fecha Entrada") && row.includes("Producto") && row.includes("Peso Neto (t)")
  );
  if(headerIdx==-1){
    document.getElementById('res-ton-camiones').innerHTML="No se detectan encabezados v√°lidos.";
    return;
  }
  let header = sheet[headerIdx];
  let idxFecha = header.findIndex(h=>h==="Fecha Entrada");
  let idxProd  = header.findIndex(h=>h==="Producto");
  let idxPeso  = header.findIndex(h=>h==="Peso Neto (t)");
  let tabla = [];
  for(let i=headerIdx+1;i<sheet.length;i++){
    let row = sheet[i];
    if(!row[idxProd]||isNaN(parseFloat(row[idxPeso]))) continue;
    tabla.push({producto:row[idxProd], peso:parseFloat(row[idxPeso]), fecha:row[idxFecha]});
  }
  dataImport = tabla;
  mostrarTonCamiones();
  logActivity('Importar datos camiones', `${tabla.length} registros`);
}

function limpiarTonCamiones(){
  dataImport=[];horas=[];dataResumen={};
  document.getElementById('res-ton-camiones').innerHTML = "";
  document.getElementById('grafico-ton').getContext('2d').clearRect(0,0,600,120);
}

function mostrarTonCamiones(){
  let resumen = {}, resumenHora = {}, horasV = [];
  dataImport.forEach(r=>{
    let prod = r.producto, peso = r.peso;
    let hora = (r.fecha||'').split(' ')[1]?r.fecha.split(' ')[1].substring(0,5):"";
    resumen[prod] = (resumen[prod]||0)+peso;
    if(!resumenHora[hora]) resumenHora[hora] = {};
    resumenHora[hora][prod] = (resumenHora[hora][prod]||0)+peso;
    if(hora && !horasV.includes(hora)) horasV.push(hora);
  });
  dataResumen=resumen;horas=horasV;
  let html = "<table><thead><tr><th>Producto</th><th>Total cami√≥n</th></tr></thead><tbody>";
  for(let prod in resumen) html += `<tr><td>${prod}</td><td>${resumen[prod].toFixed(2)} TM</td></tr>`;
  html+="</tbody></table>";
  let tmMec = Number(document.getElementById('toneladas-mec').value) || 0;
  html += `<div style='margin-top:6px'><b>Total mecanizado:</b> ${tmMec.toFixed(2)} TM<br>`;
  let tmTot = Object.values(resumen).reduce((a,b)=>a+b,0)+tmMec;
  html += `<b>Total conjunto:</b> ${tmTot.toFixed(2)} TM</div>`;
  document.getElementById('res-ton-camiones').innerHTML=html;
  graficarTonCamiones(resumenHora, tmMec);
}

function actualizarTotalToneladas(){mostrarTonCamiones();}

function graficarTonCamiones(objHoras, tmMec){
  let ctx = document.getElementById('grafico-ton').getContext('2d');
  ctx.clearRect(0,0,950,200);
  let products = {};
  Object.values(objHoras).forEach(prods=>Object.keys(prods).forEach(p=>products[p]=true));
  let labels = horas;
  if(labels.length===0) return;
  let colores = ["#28568d", "#bda25f", "#7da132", "#d48148", "#b97a7a"];
  Object.keys(products).forEach((prod,pidx)=>{
    ctx.beginPath();
    ctx.strokeStyle = colores[pidx%colores.length];
    labels.forEach((hora,i)=>{
      let y= 100-(objHoras[hora]?.[prod]||0) * 90/(Math.max(...labels.map(h=>Object.values(objHoras[h]||{}).reduce((a,b)=>a+b,0)),1));
      let x = 38 + (i*38);
      ctx.moveTo(x,y);
      ctx.lineTo(x+10,y);
    });ctx.stroke();
    ctx.fillStyle = colores[pidx%colores.length];
    labels.forEach((hora,i)=>{
      let y= 100-(objHoras[hora]?.[prod]||0) * 90/(Math.max(...labels.map(h=>Object.values(objHoras[h]||{}).reduce((a,b)=>a+b,0)),1));
      let x = 37+(i*38);
      ctx.fillRect(x,y,8,100-y);
    });
  });
  if(tmMec>0){
    ctx.beginPath();
    ctx.strokeStyle="#f29e23"; ctx.lineWidth=2;
    labels.forEach((hora,i)=>{
      let y=100-(tmMec)*90/(Math.max(...labels.map(h=>Object.values(objHoras[h]||{}).reduce((a,b)=>a+b,0))+tmMec,1));
      let x = 44 + (i*38);
      if(i==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });ctx.stroke();
  }
}
</script>
</body>
</html>
