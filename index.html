<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel de Trazabilidad de Descarga de Buques</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    /* Estilos básicos */
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f4f6fa;
      margin: 0;
      color: #19324c;
    }
    header {
      background: #102842;
      color: white;
      padding: 1rem;
      display: flex;
      align-items: center;
    }
    header img {
      height: 44px;
      margin-right: 15px;
      border-radius: 6px;
      background: #fff;
    }
    h1 {
      margin: 0.5rem;
    }
    .container {
      max-width: 1180px;
      margin: 2rem auto;
      padding: 1rem;
      background: white;
      border-radius: 14px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    section {
      margin-bottom: 2rem;
    }
    .modulo {
      padding: 1.2rem 1rem;
      margin-bottom: 2rem;
      border: 1px solid #dbe3eb;
      border-radius: 12px;
      background: #f9fbfd;
    }
    label {
      font-weight: 500;
    }
    input,
    select,
    button,
    textarea {
      margin-top: 0.2rem;
      margin-bottom: 0.6rem;
      padding: 0.4rem;
      border-radius: 7px;
      border: 1px solid #ccd2db;
    }
    button {
      background: #28568d;
      color: #fff;
      cursor: pointer;
      border: none;
      transition: background 0.2s;
    }
    button:hover {
      background: #163357;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th,
    td {
      border: 1px solid #c7d3e6;
      padding: 0.6rem;
      text-align: left;
    }
    th {
      background: #e7f0fa;
    }
    .flex-row {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
    }
    .flex-col-2 {
      flex: 1 1 310px;
    }
    .summary {
      margin-top: 1rem;
      background: #e1eaf6;
      padding: 1rem;
      border-radius: 8px;
    }
    .dashboard-card {
      background: #e6eef7;
      margin: 0.5rem;
      border-radius: 7px;
      padding: 1rem;
    }
    .status-badge {
      padding: 0.2em 0.7em;
      border-radius: 6px;
      color: #fff;
      font-size: 0.96em;
    }
    .cargado {
      background: #13ae60;
    }
    .no-cargado {
      background: #ff5858;
    }
    input[type='file'] {
      border: none;
    }
    @media (max-width: 760px) {
      .container {
        padding: 0.3rem;
      }
      .flex-row {
        flex-direction: column;
      }
      th,
      td {
        font-size: 0.98em;
      }
    }
    .legend {
      margin: 10px 0;
      font-size: 0.97em;
    }
    .legend span {
      display: inline-block;
      width: 16px;
      height: 16px;
      border-radius: 2px;
      margin-right: 5px;
      vertical-align: middle;
    }
  </style>
</head>

<body>
  <header>
    <img src="image.jpg" alt="Logo" />
    <h1>Panel de Trazabilidad de Descarga de Buques</h1>
  </header>
  <div class="container">
    <!-- Información general -->
    <section class="modulo">
      <h2>Información General del Buque</h2>
      <div class="flex-row">
        <div class="flex-col-2"><label>Nombre:</label><input id="buque-nombre" /></div>
        <div class="flex-col-2"><label>ETA (Fecha estimada):</label><input type="datetime-local" id="buque-eta" /></div>
        <div class="flex-col-2"><label>Fecha de NOR:</label><input type="datetime-local" id="buque-nor" /></div>
        <div class="flex-col-2"><label>Rata Contratada TM/día:</label><input type="number" id="buque-rata" min="1" /></div>
      </div>
      <div class="flex-row">
        <div class="flex-col-2">
          <label>Condición Contrato:</label>
          <select id="buque-condicion">
            <option value="SHINC">SHINC</option>
            <option value="SHEX">SHEX</option>
          </select>
        </div>
        <div class="flex-col-2"><label>Cantidad total de producto (TM):</label><input type="number" id="buque-tm" min="0" /></div>
        <div class="flex-col-2"><label>Inicio de Operaciones:</label><input type="datetime-local" id="inicio-op" /></div>
        <div class="flex-col-2"><label>Fin de Operaciones:</label><input type="datetime-local" id="fin-op" /></div>
      </div>
      <div class="summary" id="info-general-resumen">
        <div><b>Laytime Disponible (con ajuste lluvia):</b> <span id="laytime"></span></div>
        <div><b>Tiempo en Operación:</b> <span id="tiempo-operacion"></span></div>
      </div>
    </section>

    <!-- Productos manifestados -->
    <section class="modulo">
      <h2>Productos Manifestados</h2>
      <table id="tabla-productos">
        <thead>
          <tr>
            <th>Tipo Producto</th>
            <th>Bodega</th>
            <th>Declarado (TM)</th>
            <th>Descargado (TM)</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody id="tbody-productos"></tbody>
      </table>
      <button onclick="agregarProducto()">Agregar Producto</button>
    </section>

    <!-- Registro de Paradas / Incidentes -->
    <section class="modulo">
      <h2>Registro de Paradas / Incidentes</h2>
      <form onsubmit="registrarParada(event)">
        <div class="flex-row">
          <div class="flex-col-2">
            <label>Motivo:</label>
            <select required id="parada-motivo">
              <option value="">Elija…</option>
              <option value="LLUVIA">LLUVIA</option>
              <option value="NO CAMIONES">NO CAMIONES</option>
              <option value="MOVIMIENTO BARCO">MOVIMIENTO BARCO</option>
              <option value="MECANIZADO FALLA">MECANIZADO FALLA</option>
              <option value="BUQUE INTERNO FALLA">BUQUE INTERNO FALLA</option>
              <option value="OTROS">OTROS</option>
            </select>
          </div>
          <div class="flex-col-2">
            <label>Bodega afectada</label>
            <select id="bodega-afectada">
              <option value="1">Bodega 1</option>
              <option value="2">Bodega 2</option>
              <option value="3">Bodega 3</option>
              <option value="4">Bodega 4</option>
              <option value="5">Bodega 5</option>
              <option value="6">Bodega 6</option>
              <option value="Completo">Completo</option>
            </select>
          </div>
          <div class="flex-col-2"><label>Inicio (fecha-hora):</label><input required type="datetime-local" id="parada-inicio" /></div>
          <div class="flex-col-2"><label>Fin (fecha-hora):</label><input required type="datetime-local" id="parada-fin" /></div>
          <div class="flex-col-2" style="align-self: flex-end"><button type="submit">Registrar</button></div>
        </div>
      </form>
      <table id="tabla-paradas">
        <thead>
          <tr>
            <th>Motivo</th>
            <th>Bodega</th>
            <th>Inicio</th>
            <th>Fin</th>
            <th>Duración (h:m)</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody id="tbody-paradas"></tbody>
      </table>
      <div class="summary"><b>Tiempo Total Paradas:</b> <span id="tiempo-paradas"></span></div>
    </section>

    <!-- Tracking de Camiones -->
    <section class="modulo">
      <h2>Tracking de Camiones</h2>
      <form onsubmit="registrarCamion(event)">
        <div class="flex-row">
          <div class="flex-col-2"><label>No. Listado:</label><input required id="camion-nlistado" type="number" min="1" /></div>
          <div class="flex-col-2"><label>Placa:</label><input required id="camion-placa" /></div>
          <div class="flex-col-2"><label>Ficha:</label><input required id="camion-ficha" /></div>
          <div class="flex-col-2">
            <label>Estatus:</label>
            <select id="camion-estatus">
              <option value="Cargado">Cargado</option>
              <option value="No Cargado">No Cargado</option>
            </select>
          </div>
          <div class="flex-col-2" style="align-self: flex-end"><button type="submit">Registrar</button></div>
        </div>
      </form>
      <div style="margin-bottom: 0.7em">
        <label>Filtrar por Estatus:</label>
        <select onchange="filtrarCamiones()" id="filtro-estatus">
          <option value="Todos">Todos</option>
          <option value="Cargado">Cargado</option>
          <option value="No Cargado">No Cargado</option>
        </select>
      </div>
      <table id="tabla-camiones">
        <thead>
          <tr>
            <th>No. Listado</th>
            <th>Placa</th>
            <th>Ficha</th>
            <th>Estatus</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody id="tbody-camiones"></tbody>
      </table>
      <div class="summary">
        <b>Camiones registrados:</b> <span id="camion-total"></span> |
        <b>Camiones por hora (simulado):</b> <span id="camion-xhora"></span>
      </div>
    </section>

    <!-- Correa mecanizada -->
    <section class="modulo">
      <h2>Correa Mecanizada (por hora)</h2>
      <form onsubmit="registrarCorrea(event)">
        <div class="flex-row">
          <div class="flex-col-2">
            <label>Línea:</label>
            <select id="correa-linea">
              <option value="1">Línea 1</option>
              <option value="2">Línea 2</option>
            </select>
          </div>
          <div class="flex-col-2"><label>Producto:</label><input required id="correa-producto" /></div>
          <div class="flex-col-2"><label>Toneladas:</label><input required type="number" id="correa-tn" min="1" /></div>
          <div class="flex-col-2"><label>Hora:</label><input required type="datetime-local" id="correa-hora" /></div>
          <div class="flex-col-2" style="align-self: flex-end"><button type="submit">Registrar</button></div>
        </div>
      </form>
      <table id="tabla-correa">
        <thead>
          <tr>
            <th>Línea</th>
            <th>Producto</th>
            <th>Toneladas</th>
            <th>Hora</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody id="tbody-correa"></tbody>
      </table>
      <div class="summary">
        <b>Total Descargado por Correa:</b> <span id="total-correa"></span> TM
      </div>
    </section>

    <!-- Toneladas Camiones y Mecanizado -->
    <section class="modulo">
      <h2>Toneladas Camiones</h2>
      <input type="file" id="import-camiones" accept=".xlsx,.xls" />
      <button onclick="limpiarTonCamiones()" type="button" style="background: #fff; color: #163357; border: 1px solid #334">Limpiar datos</button>
      <div id="res-ton-camiones"></div>

      <h3 style="margin-top: 18px;">Mecanizado (Agregar líneas)</h3>
      <form onsubmit="agregarLineaMec(event)" style="margin-bottom: 10px;">
        <input id="mec-producto" placeholder="Producto" required />
        <input id="mec-tn" type="number" placeholder="Toneladas" min="0.01" required style="width: 90px" />
        <input id="mec-hora" type="time" required />
        <button>Agregar línea mecanizado</button>
      </form>
      <table id="tabla-mec">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Toneladas</th>
            <th>Hora</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div style="margin-top: 8px;">
        <b>Total mecanizado:</b> <span id="total-mec"></span> TM
      </div>
      <canvas id="grafico-ton" height="140"></canvas>
      <div class="legend">
        <span style="background: #28568d"></span> Camiones
        <span style="background: #bda25f"></span> Mecanizado
        <span style="background: #e4183a"></span> Total conjunto
      </div>
    </section>

    <!-- Total Descargado y Dashboard Ejecutivo -->
    <section class="modulo">
      <h2>Total Descargado y Dashboard Ejecutivo</h2>
      <div class="dashboard-card"><span><b>Descarga Camión:</b> <span id="dsh-tot-camion"></span></span></div>
      <div class="dashboard-card"><span><b>Descarga Mecanizado:</b> <span id="dsh-tot-mec"></span></span></div>
      <div class="dashboard-card"><span><b>Total Global:</b> <span id="dsh-tot-total"></span></span></div>
      <div class="dashboard-card"><span><b>Tiempo Bruto de Operación:</b> <span id="dsh-tiempo-bruto"></span></span></div>
      <div class="dashboard-card"><span><b>Tiempo Neto de Operación:</b> <span id="dsh-tiempo-neto"></span></span></div>
      <div class="dashboard-card"><span><b>TPH Promedio (bruto/neto):</b> <span id="dsh-tph"></span></span></div>
      <div class="dashboard-card"><span><b>Laytime Hábil Ajustado LLUVIA:</b> <span id="dsh-laytime-rest"></span></span></div>
    </section>
  </div>

  <script>
    // Variables globales
    let productos = [],
      paradas = [],
      camiones = [],
      correa = [],
      mecanizado = [];
    let laytimeHoras = 0,
      laytimeAdjusted = 0;
    let dataImport = [],
      dataResumen = {},
      horas = [];
    let tiempoBruto = 0,
      tiempoParadas = 0,
      tiempoLluvia = 0;

    // Funciones generales - Laytime y operación ajustada con lluvia
    function calcLaytime() {
      const tm = parseFloat(document.getElementById('buque-tm').value);
      const rata = parseFloat(document.getElementById('buque-rata').value);
      const condicion = document.getElementById('buque-condicion').value;
      if (tm > 0 && rata > 0) {
        let dias = tm / rata;
        if (condicion === 'SHEX') dias *= 7 / 5;
        laytimeHoras = Math.round(dias * 24);
      } else {
        laytimeHoras = 0;
      }
      ajustarLaytimeLluvia();
    }
    ['buque-tm', 'buque-rata', 'buque-condicion'].forEach((id) => {
      document.getElementById(id).addEventListener('input', calcLaytime);
    });

    function ajustarLaytimeLluvia() {
      tiempoLluvia = paradas
        .filter((p) => p.motivo === 'LLUVIA' && p.ini && p.fin)
        .reduce(
          (a, p) =>
            a + (new Date(p.fin) - new Date(p.ini)) / 3600000,
          0
        );
      laytimeAdjusted = Math.round((laytimeHoras + tiempoLluvia) * 100) / 100;
      document.getElementById('laytime').innerText =
        (laytimeAdjusted || 0) + ' horas';
    }

    // Cálculo tiempo bruto y neto
    function calcOperacion() {
      const ini = document.getElementById('inicio-op').value;
      const fin = document.getElementById('fin-op').value;
      if (!ini) {
        document.getElementById('tiempo-operacion').innerText = 'No iniciado';
        return;
      }
      const dtIni = new Date(ini);
      let dtFin = fin ? new Date(fin) : new Date();
      let diff = Math.max((dtFin - dtIni) / 3600000, 0);
      document.getElementById('tiempo-operacion').innerText = diff.toFixed(2) + ' h';
      tiempoBruto = diff;

      tiempoParadas = paradas
        .filter((p) => p.motivo !== 'LLUVIA' && p.ini && p.fin)
        .reduce(
          (a, p) =>
            a + (new Date(p.fin) - new Date(p.ini)) / 3600000,
          0
        );
      return diff;
    }
    ['inicio-op', 'fin-op'].forEach((id) => {
      document
        .getElementById(id)
        .addEventListener('input', () => {
          calcOperacion();
          updateDashboard();
        });
    });

    // Productos, paradas, camiones, correa (igual que en versiones anteriores)
    function renderProductos() {
      const tbody = document.getElementById('tbody-productos');
      tbody.innerHTML = '';
      productos.forEach((p, i) => {
        tbody.innerHTML += `<tr>
          <td>${p.tipo || ''}</td>
          <td>${p.bodega || ''}</td>
          <td><input type='number' min='0' style='width:70px' value='${p.declarado}' onchange='actProdDeclarado(${i}, this.value)'></td>
          <td><input type='number' min='0' style='width:70px' value='${p.descargado}' onchange='actProdDescargado(${i}, this.value)'></td>
          <td><button onclick="eliminaProducto(${i})">Eliminar</button></td>
        </tr>`;
      });
    }
    function actProdDeclarado(idx, vl) {
      productos[idx].declarado = Number(vl);
      renderProductos();
      updateDashboard();
    }
    function actProdDescargado(idx, vl) {
      productos[idx].descargado = Number(vl);
      renderProductos();
      updateDashboard();
    }
    function agregarProducto() {
      productos.push({ tipo: '', bodega: '', declarado: 0, descargado: 0 });
      renderProductos();
    }
    function eliminaProducto(idx) {
      productos.splice(idx, 1);
      renderProductos();
      updateDashboard();
    }
    document.addEventListener('DOMContentLoaded', () => {
      renderProductos();
    });

    function registrarParada(e) {
      e.preventDefault();
      let motivo = document.getElementById('parada-motivo').value,
        bodega = document.getElementById('bodega-afectada').value,
        ini = document.getElementById('parada-inicio').value,
        fin = document.getElementById('parada-fin').value;
      paradas.push({ motivo, bodega, ini, fin });
      renderParadas();
      ajustarLaytimeLluvia();
      updateDashboard();
    }
    function renderParadas() {
      const tbody = document.getElementById('tbody-paradas');
      tbody.innerHTML = '';
      paradas.forEach((p, i) => {
        let duration = '',
          diff = 0;
        if (p.ini && p.fin) {
          const d1 = new Date(p.ini),
            d2 = new Date(p.fin);
          diff = (d2 - d1) / 3600000;
          duration = `${Math.floor(diff)}h ${Math.round((diff % 1) * 60)}m`;
        }
        tbody.innerHTML += `<tr>
          <td>${p.motivo}</td>
          <td>${p.bodega}</td>
          <td>${p.ini.replace('T', ' ')}</td>
          <td>${p.fin.replace('T', ' ')}</td>
          <td>${duration}</td>
          <td><button onclick="eliminaParada(${i})">Eliminar</button></td>
        </tr>`;
      });
      let total = 0;
      paradas.forEach((p) => {
        if (p.ini && p.fin) total += (new Date(p.fin) - new Date(p.ini)) / 3600000;
      });
      document.getElementById('tiempo-paradas').innerText = total.toFixed(2) + ' h';
    }
    function eliminaParada(idx) {
      paradas.splice(idx, 1);
      renderParadas();
      ajustarLaytimeLluvia();
      updateDashboard();
    }

    function registrarCamion(e) {
      e.preventDefault();
      let nlist = document.getElementById('camion-nlistado').value,
        placa = document.getElementById('camion-placa').value,
        ficha = document.getElementById('camion-ficha').value,
        estatus = document.getElementById('camion-estatus').value;
      if (
        camiones.find(
          (c) => c.nlist === nlist && (c.placa === placa || c.ficha === ficha)
        )
      ) {
        alert('Ya existe esa ficha o placa en ese listado');
        return false;
      }
      camiones.push({ nlist, placa, ficha, estatus });
      renderCamiones();
    }
    function renderCamiones() {
      const tbody = document.getElementById('tbody-camiones');
      tbody.innerHTML = '';
      let filtro = document.getElementById('filtro-estatus').value;
      let visibles = camiones.filter((c) =>
        filtro === 'Todos' ? true : c.estatus === filtro
      );
      visibles.forEach((c, i) => {
        tbody.innerHTML += `<tr>
          <td>${c.nlist}</td>
          <td>${c.placa}</td>
          <td>${c.ficha}</td>
          <td>
            <span class="status-badge ${
              c.estatus === 'Cargado' ? 'cargado' : 'no-cargado'
            }">${c.estatus}</span>
          </td>
          <td><button onclick="eliminaCamion(${i})">Eliminar</button></td>
        </tr>`;
      });
      document.getElementById('camion-total').innerText = camiones.length;
      document.getElementById(
        'camion-xhora'
      ).innerText = Math.round(
        camiones.length / Math.max(calcOperacion() || 1, 1) / 24
      ).toFixed(1);
    }
    function eliminaCamion(idx) {
      camiones.splice(idx, 1);
      renderCamiones();
    }
    function filtrarCamiones() {
      renderCamiones();
    }
    function registrarCorrea(e) {
      e.preventDefault();
      let linea = document.getElementById('correa-linea').value,
        prod = document.getElementById('correa-producto').value,
        tn = document.getElementById('correa-tn').value,
        hora = document.getElementById('correa-hora').value;
      correa.push({ linea, prod, tn: Number(tn), hora });
      renderCorrea();
      updateDashboard();
    }
    function renderCorrea() {
      const tbody = document.getElementById('tbody-correa');
      tbody.innerHTML = '';
      correa.forEach((c, i) => {
        tbody.innerHTML += `<tr>
          <td>${c.linea}</td><td>${c.prod}</td><td>${c.tn}</td><td>${
          c.hora.replace('T', ' ')}</td>
          <td><button onclick="eliminaCorrea(${i})">Eliminar</button></td>
        </tr>`;
      });
      let total = correa.reduce((acc, c) => acc + c.tn, 0);
      document.getElementById('total-correa').innerText = total.toFixed(2);
    }
    function eliminaCorrea(idx) {
      correa.splice(idx, 1);
      renderCorrea();
      updateDashboard();
    }
    function updateTotales() {
      let totalCamion = productos.reduce((a, p) => a + p.descargado, 0);
      let totalCorrea = correa.reduce((a, c) => a + c.tn, 0);
      document.getElementById('total-descargado').innerHTML = `<b>Total descargado camión:</b> ${totalCamion.toFixed(
        2
      )} TM <b>| Correa:</b> ${totalCorrea.toFixed(2)} TM <b>| Total:</b> ${(
        totalCamion + totalCorrea
      ).toFixed(2)} TM`;
    }
    // --- TONELADAS MECANIZADO = arreglo dinamico con suma
    let mecanizado = [];
    function agregarLineaMec(e) {
      e.preventDefault();
      mecanizado.push({
        producto: document.getElementById('mec-producto').value,
        tn: Number(document.getElementById('mec-tn').value),
        hora: document.getElementById('mec-hora').value,
      });
      renderTablaMec();
      mostrarTonCamiones();
    }
    function renderTablaMec() {
      const tb = document.querySelector('#tabla-mec tbody');
      tb.innerHTML = '';
      mecanizado.forEach((m, i) => {
        tb.innerHTML += `<tr><td>${m.producto}</td><td>${m.tn}</td><td>${m.hora}</td>
            <td><button onclick="eliminaMec(${i})">Eliminar</button></td></tr>`;
      });
      document.getElementById('total-mec').innerText = mecanizado
        .reduce((a, b) => a + b.tn, 0)
        .toFixed(2);
    }
    function eliminaMec(idx) {
      mecanizado.splice(idx, 1);
      renderTablaMec();
      mostrarTonCamiones();
    }
    // IMPORTAR TONELADAS CAMIONES - SheetJS
    let dataImport = [],
      dataResumen = {},
      horas = [];
    document
      .getElementById('import-camiones')
      .addEventListener('change', function (evt) {
        const file = evt.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
          const workbook = XLSX.read(new Uint8Array(e.target.result), {
            type: 'array',
          });
          const name = workbook.SheetNames[0];
          const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[name], {
            header: 1,
            defval: '',
          });
          procesarTonCamiones(sheet);
        };
        reader.readAsArrayBuffer(file);
      });
    function procesarTonCamiones(sheet) {
      let headerIdx = sheet.findIndex(
        (row) =>
          row.includes('Fecha Entrada') &&
          row.includes('Producto') &&
          row.includes('Peso Neto (t)')
      );
      if (headerIdx == -1) {
        document.getElementById('res-ton-camiones').innerHTML =
          'No se detectan encabezados válidos.';
        return;
      }
      let header = sheet[headerIdx];
      let idxFecha = header.findIndex((h) => h === 'Fecha Entrada');
      let idxProd = header.findIndex((h) => h === 'Producto');
      let idxPeso = header.findIndex((h) => h === 'Peso Neto (t)');
      let tabla = [];
      for (let i = headerIdx + 1; i < sheet.length; i++) {
        let row = sheet[i];
        if (!row[idxProd] || isNaN(parseFloat(row[idxPeso]))) continue;
        tabla.push({
          producto: row[idxProd],
          peso: parseFloat(row[idxPeso]),
          fecha: row[idxFecha],
        });
      }
      dataImport = tabla;
      mostrarTonCamiones();
    }
    function limpiarTonCamiones() {
      dataImport = [];
      horas = [];
      dataResumen = {};
      document.getElementById('res-ton-camiones').innerHTML = '';
      document.getElementById('grafico-ton').getContext('2d').clearRect(0, 0, 600, 140);
      updateDashboard();
    }
    function mostrarTonCamiones() {
      let resumen = {},
        resumenHora = {},
        horasV = [];
      dataImport.forEach((r) => {
        let prod = r.producto,
          peso = r.peso;
        let hora = r.fecha.split(' ')[1] ? r.fecha.split(' ')[1].substring(0, 5) : '';
        resumen[prod] = (resumen[prod] || 0) + peso;
        if (!resumenHora[hora]) resumenHora[hora] = {};
        resumenHora[hora][prod] = (resumenHora[hora][prod] || 0) + peso;
        if (hora && !horasV.includes(hora)) horasV.push(hora);
      });
      let resumenMec = {},
        resumenHoraMec = {};
      mecanizado.forEach((m) => {
        resumenMec[m.producto] = (resumenMec[m.producto] || 0) + m.tn;
        if (!resumenHoraMec[m.hora]) resumenHoraMec[m.hora] = {};
        resumenHoraMec[m.hora][m.producto] =
          (resumenHoraMec[m.hora][m.producto] || 0) + m.tn;
        if (m.hora && !horasV.includes(m.hora)) horasV.push(m.hora);
      });
      horasV = horasV.sort();
      dataResumen = resumen;
      horas = horasV;
      let html = '<table><thead><tr><th>Producto</th><th>Camión</th><th>Mecanizado</th><th>Total</th></tr></thead><tbody>';
      let sumaCamion = 0,
        sumaMec = 0;
      let todosProds = Array.from(new Set([...Object.keys(resumen), ...Object.keys(resumenMec)]));
      todosProds.forEach((prod) => {
        let valC = resumen[prod] || 0,
          valM = resumenMec[prod] || 0,
          ttl = valC + valM;
        sumaCamion += valC;
        sumaMec += valM;
        html += `<tr><td>${prod}</td><td>${valC.toFixed(2)}</td><td>${valM.toFixed(2)}</td><td>${ttl.toFixed(2)}</td></tr>`;
      });
      html +=
        '</tbody></table><div style=\'margin-top:6px\'><b>Total camión:</b> ' +
        sumaCamion.toFixed(2) +
        ' TM<br><b>Total mecanizado:</b> ' +
        sumaMec.toFixed(2) +
        ' TM<br><b>Total conjunto:</b> ' +
        (sumaCamion + sumaMec).toFixed(2) +
        ' TM</div>';
      document.getElementById('res-ton-camiones').innerHTML = html;
      document.getElementById('total-mec').innerText = sumaMec.toFixed(2);
      ultimoResumenGlobal = { tc: sumaCamion, tm: sumaMec, total: sumaCamion + sumaMec };
      updateDashboard();
      graficarTonCamiones(resumenHora, resumenHoraMec, horasV);
    }
    let ultimoResumenGlobal = { tc: 0, tm: 0, total: 0 };
    function updateDashboard() {
      document.getElementById('dsh-tot-camion').innerText = ultimoResumenGlobal.tc.toFixed(2) + ' TM';
      document.getElementById('dsh-tot-mec').innerText = ultimoResumenGlobal.tm.toFixed(2) + ' TM';
      document.getElementById('dsh-tot-total').innerText = ultimoResumenGlobal.total.toFixed(2) + ' TM';
      calcOperacion();
      let neto = Math.max(tiempoBruto - tiempoParadas, 0);
      document.getElementById('dsh-tiempo-bruto').innerText = tiempoBruto.toFixed(2) + ' h';
      document.getElementById('dsh-tiempo-neto').innerText = neto.toFixed(2) + ' h';
      let tphBruto = tiempoBruto > 0 ? ultimoResumenGlobal.total / tiempoBruto : 0;
      let tphNeto = neto > 0 ? ultimoResumenGlobal.total / neto : 0;
      document.getElementById('dsh-tph').innerText = `${tphBruto.toFixed(1)} / ${tphNeto.toFixed(1)} TM/h`;
      let disponible = (laytimeAdjusted || 0) - (tiempoBruto || 0);
      document.getElementById('dsh-laytime-rest').innerText = (disponible > 0 ? disponible.toFixed(2) : '0') + ' horas';
    }
    function graficarTonCamiones(objHoras, objHorasMec, horasV) {
      let ctx = document.getElementById('grafico-ton').getContext('2d');
      ctx.clearRect(0, 0, 950, 140);
      let colors = ['#28568d', '#bda25f', '#e4183a'];
      // Camiones azul barras
      horasV.forEach((hora, i) => {
        let suma = Object.values(objHoras[hora] || {}).reduce((a, b) => a + b, 0);
        let x = 35 + i * 40,
          y =
            120 -
            (suma * 80) /
              Math.max(
                1,
                ...horasV.map((hh) =>
                  Object.values(objHoras[hh] || {}).reduce((a, b) => a + b, 0)
                )
              );
        ctx.fillStyle = colors[0];
        ctx.fillRect(x, y, 15, 120 - y - 9);
      });
      // Mecanizado barras doradas
      horasV.forEach((hora, i) => {
        let suma = Object.values(objHorasMec[hora] || {}).reduce((a, b) => a + b, 0);
        let x = 53 + i * 40,
          y =
            120 -
            (suma * 80) /
              Math.max(
                1,
                ...horasV.map((hh) =>
                  Object.values(objHorasMec[hh] || {}).reduce((a, b) => a + b, 0)
                )
              );
        ctx.fillStyle = colors[1];
        ctx.fillRect(x, y, 15, 120 - y - 9);
      });
      // Total línea roja
      ctx.beginPath();
      ctx.strokeStyle = colors[2];
      ctx.lineWidth = 2;
      horasV.forEach((hora, i) => {
        let y =
          120 -
          ((Object.values(objHoras[hora] || {}).reduce((a, b) => a + b, 0) +
            Object.values(objHorasMec[hora] || {}).reduce((a, b) => a + b, 0)) *
            80) /
            Math.max(
              1,
              ...horasV.map(
                (hh) =>
                  Object.values(objHoras[hh] || {}).reduce((a, b) => a + b, 0) +
                  Object.values(objHorasMec[hh] || {}).reduce((a, b) => a + b, 0)
              )
            );
        let x = 43 + i * 40;
        if (i == 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
      // Etiquetas hora
      ctx.fillStyle = '#19324c';
      ctx.font = '11px Segoe UI';
      horasV.forEach((hora, i) => ctx.fillText(hora, 35 + i * 40, 134));
    }
  </script>
</body>
</html>
