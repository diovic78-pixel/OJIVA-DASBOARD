<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Trazabilidad de Descarga de Buques</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2355a4;
      --secondary: #3498db;
      --success: #27ae60;
      --danger: #e74c3c;
      --warning: #f39c12;
      --light: #f5f7fa;
      --white: #fff;
      --surface: #f9fbfd;
      --card: #e6eef7;
      --border: #dbe3eb;
      --shadow: 0 2px 8px rgba(0,0,0,0.09);
      --radius: 14px;
      --radius-sm: 8px;
      --radius-xs: 6px;
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--light);
      margin: 0;
      color: #19324c;
    }
    header {
      background: linear-gradient(135deg,var(--primary), #102842 65%);
      color: var(--white);
      padding: 1.3rem 1.8rem;
      display: flex;
      align-items: center;
      box-shadow: var(--shadow);
      position: sticky; top: 0; z-index: 10;
    }
    header img {
      height: 48px;
      margin-right: 16px;
      border-radius: var(--radius-sm);
      background: #fff;
      box-shadow: 0 1px 8px #0002;
      padding:6px;
      object-fit: contain;
    }
    h1 {
      font-size:1.5rem;
      font-weight:700;
      margin-right:1.8rem;
      letter-spacing: 1px;
    }
    .header-icon {
      font-size:2.1rem;
      margin-right:10px;
      vertical-align: middle;
      color: var(--warning);
    }
    .container {
      max-width:1180px;
      margin:2rem auto;
      padding:1.2rem;
      background:var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    section {
      margin-bottom:2.4rem;
    }
    .modulo {
      padding:1.4rem 1rem;
      margin-bottom:2.4rem;
      border:1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--surface);
      box-shadow: 0 2px 8px #0001;
    }
    .section-header {
      display: flex;
      align-items: center;
      margin-bottom:1.1rem;
    }
    .section-header i {
      font-size:1.5rem;
      margin-right:0.7rem;
      color: var(--primary);
    }
    .section-header h2 {
      margin:0; font-size:1.13rem; font-weight:600;
    }
    label {
      font-weight: 500; margin-right:5px;
    }
    input, select, button, textarea {
      margin-top:0.18rem; margin-bottom:0.57rem; padding:0.44rem;
      border-radius: var(--radius-xs); border:1px solid #ccd2db;
      font-size:1em;
      outline:none;
      transition: box-shadow 0.14s;
    }
    input:focus, select:focus, textarea:focus {
      box-shadow: 0 0 2px var(--primary);
      border-color: var(--primary);
    }
    button {
      background: var(--primary);
      color: var(--white);
      cursor: pointer;
      border: none; font-weight: 500;
      transition: background 0.2s,box-shadow 0.19s;
      display: inline-flex; align-items: center; gap:7px;
      box-shadow: 0 2px 6px #0001;
      border-radius:var(--radius-xs);
      padding: 0.6rem 1rem;
    }
    button i { font-size:1.14em;}
    button:hover {
      background: var(--secondary);
      box-shadow: 0 2px 10px #0002;
    }
    .icon-btn { background: none; color: var(--primary); border: 1px solid #ccd2db; }
    .icon-btn:hover { background: var(--primary); color: #fff; }
    table {
      width: 100%; border-collapse: collapse; margin-top: 0.5rem;
      background: var(--white); border-radius: var(--radius-xs); overflow:hidden;
      box-shadow: 0 2px 7px #0001;
    }
    th, td {
      border: 1px solid #c7d3e6;
      padding: 0.6rem;
      text-align: left;
      font-size:0.97em;
      background: var(--white);
    }
    th {
      background: #e7f0fa;
      font-weight: 600;
    }
    tr:hover td { background: #f0f8ff; }
    .flex-row {
      display: flex; gap: 1.5rem; flex-wrap: wrap;
    }
    .flex-col-2 { flex: 1 1 280px;}
    .summary {
      margin-top:0.9rem; background: #e1eaf6; padding:1rem;
      border-radius:8px; font-size: 1em;
      box-shadow: 0 1px 6px #0001;
    }
    .dashboard-card {
      background: var(--card);
      margin: 0.6rem 0;
      border-radius: var(--radius-xs);
      padding: 1.2rem 1.1rem;
      display: flex; align-items: center; gap: 13px;
      font-size: 1.02em; font-weight: 500;
      box-shadow: 0 2px 9px #00005a08;
    }
    .kpi-value {
      font-size:1.33em; font-weight:700; margin-left:7px;
      color: var(--success);
      letter-spacing: 1px;
    }
    .kpi-icon {
      font-size:1.71em; color: var(--primary);
      margin-right:7px;
    }
    .status-badge {
      padding:0.21em 0.7em; border-radius:6px;
      color:#fff; font-size:0.98em;
      display: inline-flex; align-items: center;
      gap:4px; font-weight:500;
    }
    .cargado { background: var(--success);}
    .no-cargado { background: var(--danger);}
    .status-badge i {font-size:1em;}
    .legend {
      margin: 10px 0;
      font-size: 0.97em;
    }
    .legend span {
      display: inline-block;
      width: 16px;
      height: 16px;
      border-radius: 2px;
      margin-right: 5px;
      vertical-align: middle;
    }
    @media (max-width: 900px) {
      .container {padding:0.5rem;}
      .flex-row {flex-direction:column;}
      th, td {font-size:0.99em;}
      .dashboard-card {padding:0.9rem 0.7rem;}
    }
    @media (max-width:500px) {
      header {padding:1rem 0.3rem;}
      h1 {font-size:1rem;}
    }
  </style>
</head>
<body>
<header>
  <img src="image.jpg" alt="Logo" />
  <span class="header-icon"><i class="fas fa-ship"></i></span>
  <h1>Panel de Trazabilidad de Descarga de Buques</h1>
</header>
<div class="container">

  <!-- Información General -->
  <section class="modulo" id="mod-info-general">
    <div class="section-header"><i class="fas fa-ship"></i><h2>Información General del Buque</h2></div>
    <div class="flex-row">
      <div class="flex-col-2"><label><i class="fa fa-id-card"></i> Nombre:</label><input id="buque-nombre"></div>
      <div class="flex-col-2"><label><i class="fa fa-calendar"></i> ETA:</label><input type="datetime-local" id="buque-eta"></div>
      <div class="flex-col-2"><label><i class="fa fa-calendar-plus"></i> Fecha NOR:</label><input type="datetime-local" id="buque-nor"></div>
      <div class="flex-col-2"><label><i class="fa fa-tags"></i> Rata Contratada TM/día:</label><input type="number" id="buque-rata" min="1"></div>
    </div>
    <div class="flex-row">
      <div class="flex-col-2"><label><i class="fa fa-file-alt"></i> Condición Contrato:</label>
        <select id="buque-condicion">
          <option value="SHINC">SHINC</option>
          <option value="SHEX">SHEX</option>
        </select>
      </div>
      <div class="flex-col-2"><label><i class="fa fa-weight-scale"></i> Total Producto (TM):</label><input type="number" id="buque-tm" min="0"></div>
      <div class="flex-col-2"><label><i class="fa fa-play"></i> Inicio Operación:</label><input type="datetime-local" id="inicio-op"></div>
      <div class="flex-col-2"><label><i class="fa fa-stop"></i> Fin Operación:</label><input type="datetime-local" id="fin-op"></div>
    </div>
    <div class="summary" id="info-general-resumen">
      <div><b>Laytime Disponible:</b> <span id="laytime">0 horas</span></div>
      <div><b>Tiempo en Operación: </b><span id="tiempo-operacion">No iniciado</span></div>
    </div>
  </section>

  <!-- Productos Manifestados -->
  <section class="modulo">
    <div class="section-header"><i class="fa fa-boxes"></i><h2>Productos Manifestados</h2></div>
    <div style="margin-bottom:1rem;">
      <label><i class="fa fa-plus-square"></i> Agregar Producto:</label>
      <div class="flex-row">
        <select id="nuevo-producto-tipo">
          <option value="">Seleccione producto...</option>
          <option value="Maíz Americano">Maíz Americano</option>
          <option value="Maíz Argentino">Maíz Argentino</option>
          <option value="Maíz Brasileño">Maíz Brasileño</option>
          <option value="DNS">DNS</option>
          <option value="HRW">HRW</option>
          <option value="SRW">SRW</option>
          <option value="Frijol">Frijol</option>
          <option value="Cascarilla">Cascarilla</option>
          <option value="Aceite de Palma">Aceite de Palma</option>
          <option value="Palmite">Palmite</option>
        </select>
        <select id="nuevo-producto-bodega">
          <option value="">Seleccione bodega...</option>
          <option value="1">Bodega 1</option>
          <option value="2">Bodega 2</option>
          <option value="3">Bodega 3</option>
          <option value="4">Bodega 4</option>
          <option value="5">Bodega 5</option>
          <option value="6">Bodega 6</option>
        </select>
        <button type="button" onclick="agregarProducto()"><i class="fa fa-plus-circle"></i> Agregar</button>
      </div>
    </div>
    <table id="tabla-productos">
      <thead>
        <tr>
          <th><i class="fa fa-box"></i> Producto</th>
          <th><i class="fa fa-warehouse"></i> Bodega</th>
          <th><i class="fa fa-clipboard-list"></i> Declarado (TM)</th>
          <th><i class="fa fa-truck-loading"></i> Descargado (TM)</th>
          <th><i class="fa fa-trash-alt"></i> Acción</th>
        </tr>
      </thead>
      <tbody id="tbody-productos"></tbody>
    </table>
  </section>

  <!-- Registro Paradas -->
  <section class="modulo">
    <div class="section-header"><i class="fa fa-clock"></i><h2>Registro de Paradas / Incidentes</h2></div>
    <form onsubmit="registrarParada(event)">
      <div class="flex-row">
        <div class="flex-col-2">
          <label><i class="fa fa-exclamation-triangle"></i> Motivo:</label>
          <select required id="parada-motivo">
            <option value="">Elija…</option>
            <option value="LLUVIA">LLUVIA</option>
            <option value="NO CAMIONES">NO CAMIONES</option>
            <option value="MOVIMIENTO BARCO">MOVIMIENTO BARCO</option>
            <option value="MECANIZADO FALLA">MECANIZADO FALLA</option>
            <option value="BUQUE INTERNO FALLA">BUQUE INTERNO FALLA</option>
            <option value="OTROS">OTROS</option>
          </select>
        </div>
        <div class="flex-col-2">
          <label><i class="fa fa-warehouse"></i> Bodega Afectada</label>
          <select id="bodega-afectada">
            <option value="1">Bodega 1</option>
            <option value="2">Bodega 2</option>
            <option value="3">Bodega 3</option>
            <option value="4">Bodega 4</option>
            <option value="5">Bodega 5</option>
            <option value="6">Bodega 6</option>
            <option value="Completo">Completo</option>
          </select>
        </div>
        <div class="flex-col-2">
          <label><i class="fa fa-play-circle"></i> Inicio:</label>
          <input required type="datetime-local" id="parada-inicio">
        </div>
        <div class="flex-col-2">
          <label><i class="fa fa-stop-circle"></i> Fin:</label>
          <input required type="datetime-local" id="parada-fin">
        </div>
        <div class="flex-col-2" style="align-self: flex-end;">
          <button type="submit"><i class="fa fa-plus"></i> Registrar</button>
        </div>
      </div>
    </form>
    <table id="tabla-paradas">
      <thead>
        <tr>
          <th><i class="fa fa-bolt"></i> Motivo</th>
          <th><i class="fa fa-warehouse"></i> Bodega</th>
          <th><i class="fa fa-play"></i> Inicio</th>
          <th><i class="fa fa-stop"></i> Fin</th>
          <th><i class="fa fa-history"></i> Duración (h:m)</th>
          <th><i class="fa fa-trash-alt"></i> Acción</th>
        </tr>
      </thead>
      <tbody id="tbody-paradas"></tbody>
    </table>
    <div class="summary"><b>Tiempo Total Paradas:</b> <span id="tiempo-paradas">0.00 h</span></div>
  </section>

  <!-- Tracking de Camiones -->
  <section class="modulo">
    <div class="section-header"><i class="fa fa-truck"></i><h2>Tracking de Camiones</h2></div>
    <form onsubmit="registrarCamion(event)">
      <div class="flex-row">
        <div class="flex-col-2">
          <label><i class="fa fa-list-ol"></i> Listado:</label>
          <input required id="camion-nlistado" type="number" min="1">
        </div>
        <div class="flex-col-2">
          <label><i class="fa fa-id-badge"></i> Placa:</label>
          <input required id="camion-placa">
        </div>
        <div class="flex-col-2">
          <label><i class="fa fa-file-signature"></i> Ficha:</label>
          <input required id="camion-ficha">
        </div>
        <div class="flex-col-2">
          <label><i class="fa fa-clipboard-check"></i> Estatus:</label>
          <select id="camion-estatus">
            <option value="Cargado">Cargado</option>
            <option value="No Cargado">No Cargado</option>
          </select>
        </div>
        <div class="flex-col-2" style="align-self: flex-end;">
          <button type="submit"><i class="fa fa-save"></i> Registrar</button>
        </div>
      </div>
    </form>
    <div style="margin-bottom:0.7em;">
      <label><i class="fa fa-filter"></i> Filtrar por Estatus:</label>
      <select onchange="filtrarCamiones()" id="filtro-estatus">
        <option value="Todos">Todos</option>
        <option value="Cargado">Cargado</option>
        <option value="No Cargado">No Cargado</option>
      </select>
    </div>
    <table id="tabla-camiones">
      <thead>
        <tr>
          <th><i class="fa fa-list-ol"></i> Listado</th>
          <th><i class="fa fa-id-badge"></i> Placa</th>
          <th><i class="fa fa-file-signature"></i> Ficha</th>
          <th><i class="fa fa-clipboard-check"></i> Estatus</th>
          <th><i class="fa fa-trash-alt"></i> Acción</th>
        </tr>
      </thead>
      <tbody id="tbody-camiones"></tbody>
    </table>
    <div class="summary">
      <span><i class="fa fa-truck"></i> <b>Camiones registrados:</b> <span id="camion-total">0</span></span>
      <span style="margin-left:25px;"><i class="fa fa-clock"></i> <b>Camiones por hora:</b> <span id="camion-xhora">0.0</span></span>
    </div>
  </section>

  <!-- Correa Mecanizada -->
  <section class="modulo">
    <div class="section-header"><i class="fa fa-cogs"></i><h2>Correa Mecanizada (por hora)</h2></div>
    <form onsubmit="registrarCorrea(event)">
      <div class="flex-row">
        <div class="flex-col-2">
          <label><i class="fa fa-project-diagram"></i> Línea:</label>
          <select id="correa-linea">
            <option value="1">Línea 1</option>
            <option value="2">Línea 2</option>
          </select>
        </div>
        <div class="flex-col-2">
          <label><i class="fa fa-box"></i> Producto:</label>
          <input required id="correa-producto">
        </div>
        <div class="flex-col-2">
          <label><i class="fa fa-balance-scale-left"></i> Toneladas:</label>
          <input required type="number" id="correa-tn" min="1">
        </div>
        <div class="flex-col-2">
          <label><i class="fa fa-clock"></i> Hora:</label>
          <input required type="datetime-local" id="correa-hora">
        </div>
        <div class="flex-col-2" style="align-self: flex-end;">
          <button type="submit"><i class="fa fa-plus"></i> Registrar</button>
        </div>
      </div>
    </form>
    <table id="tabla-correa">
      <thead>
        <tr>
          <th><i class="fa fa-project-diagram"></i> Línea</th>
          <th><i class="fa fa-box"></i> Producto</th>
          <th><i class="fa fa-balance-scale-left"></i> Toneladas</th>
          <th><i class="fa fa-clock"></i> Hora</th>
          <th><i class="fa fa-trash-alt"></i> Acción</th>
        </tr>
      </thead>
      <tbody id="tbody-correa"></tbody>
    </table>
    <div class="summary">
      <b><i class="fa fa-box"></i> Total Descargado por Correa:</b> <span id="total-correa">0.00</span> TM
    </div>
  </section>

  <!-- Toneladas Camiones -->
  <section class="modulo">
    <div class="section-header"><i class="fa fa-file-excel"></i><h2>TONELADAS CAMIONES</h2></div>
    <input type="file" id="import-camiones" accept=".xlsx,.xls"/>
    <button onclick="limpiarTonCamiones()" type="button" class="icon-btn"><i class="fa fa-trash"></i> Limpiar datos</button>
    <h3 style="margin-top: 18px;"><i class="fa fa-cogs"></i> Mecanizado (Agregar líneas)</h3>
    <form onsubmit="agregarLineaMec(event)" style="margin-bottom: 10px;">
      <input id="mec-producto" placeholder="Producto" required />
      <input id="mec-tn" type="number" placeholder="Toneladas" min="0.01" step="0.01" required style="width: 90px" />
      <input id="mec-hora" type="time" required />
      <button type="submit"><i class="fa fa-plus"></i> Agregar línea mecanizado</button>
    </form>
    <table id="tabla-mec">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Toneladas</th>
          <th>Hora</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div style="margin-top: 8px;">
      <b>Total mecanizado:</b> <span id="total-mec">0.00</span> TM
    </div>
    <div id="res-ton-camiones"></div>
    <canvas id="grafico-ton" width="950" height="140"></canvas>
    <div class="legend">
      <span style="background: #28568d"></span> Camiones
      <span style="background: #bda25f"></span> Mecanizado
      <span style="background: #e4183a"></span> Total conjunto
    </div>
  </section>

  <!-- Total Descargado y Dashboard Ejecutivo -->
  <section class="modulo">
    <div class="section-header"><i class="fa fa-chart-bar"></i><h2>Total Descargado y Dashboard Ejecutivo</h2></div>
    <div class="dashboard-card"><i class="fa fa-truck kpi-icon"></i><span><b>Descarga Camión:</b> <span class="kpi-value" id="dsh-tot-camion">0.00 TM</span></span></div>
    <div class="dashboard-card"><i class="fa fa-cogs kpi-icon"></i><span><b>Descarga Mecanizado:</b> <span class="kpi-value" id="dsh-tot-mec">0.00 TM</span></span></div>
    <div class="dashboard-card"><i class="fa fa-layer-group kpi-icon"></i><span><b>Total Global:</b> <span class="kpi-value" id="dsh-tot-total">0.00 TM</span></span></div>
    <div class="dashboard-card"><i class="fa fa-clock kpi-icon"></i><span><b>Tiempo Bruto de Operación:</b> <span class="kpi-value" id="dsh-tiempo-bruto">0.00 h</span></span></div>
    <div class="dashboard-card"><i class="fa fa-stopwatch kpi-icon"></i><span><b>Tiempo Neto de Operación:</b> <span class="kpi-value" id="dsh-tiempo-neto">0.00 h</span></span></div>
    <div class="dashboard-card"><i class="fa fa-chart-line kpi-icon"></i><span><b>TPH Promedio (bruto/neto):</b> <span class="kpi-value" id="dsh-tph">0.0 / 0.0 TM/h</span></span></div>
    <div class="dashboard-card"><i class="fa fa-calendar-minus kpi-icon"></i><span><b>Laytime Hábil Ajustado LLUVIA:</b> <span class="kpi-value" id="dsh-laytime-rest">0 horas</span></span></div>
  </section>
</div>

<script>
// ==== VARIABLES GLOBALES ====
let productos = [], paradas = [], camiones = [], correa = [], mecanizado = [];
let laytimeHoras = 0, laytimeAdjusted = 0;
let dataImport = [], dataResumen = {}, horas = [];
let tiempoBruto = 0, tiempoParadas = 0, tiempoLluvia = 0;

// ==== LAYTIME Y OPERACIÓN ====
function calcLaytime() {
  const tm = parseFloat(document.getElementById('buque-tm').value) || 0;
  const rata = parseFloat(document.getElementById('buque-rata').value) || 0;
  const condicion = document.getElementById('buque-condicion').value;
  if (tm > 0 && rata > 0) {
    let dias = tm / rata;
    if (condicion === 'SHEX') dias *= 7 / 5;
    laytimeHoras = Math.round(dias * 24);
  } else {
    laytimeHoras = 0;
  }
  ajustarLaytimeLluvia();
}

['buque-tm', 'buque-rata', 'buque-condicion'].forEach((id) => {
  document.getElementById(id).addEventListener('input', calcLaytime);
});

function ajustarLaytimeLluvia() {
  tiempoLluvia = paradas
    .filter((p) => p.motivo === 'LLUVIA' && p.ini && p.fin)
    .reduce((a, p) => a + (new Date(p.fin) - new Date(p.ini)) / 3600000, 0);
  laytimeAdjusted = Math.round((laytimeHoras + tiempoLluvia) * 100) / 100;
  document.getElementById('laytime').innerText = (laytimeAdjusted || 0) + ' horas';
}

function calcOperacion() {
  const ini = document.getElementById('inicio-op').value;
  const fin = document.getElementById('fin-op').value;
  if (!ini) {
    document.getElementById('tiempo-operacion').innerText = 'No iniciado';
    return 0;
  }
  const dtIni = new Date(ini);
  let dtFin = fin ? new Date(fin) : new Date();
  let diff = Math.max((dtFin - dtIni) / 3600000, 0);
  document.getElementById('tiempo-operacion').innerText = diff.toFixed(2) + ' h';
  tiempoBruto = diff;

  tiempoParadas = paradas
    .filter((p) => p.motivo !== 'LLUVIA' && p.ini && p.fin)
    .reduce((a, p) => a + (new Date(p.fin) - new Date(p.ini)) / 3600000, 0);
  return diff;
}

['inicio-op', 'fin-op'].forEach((id) => {
  document.getElementById(id).addEventListener('input', () => {
    calcOperacion();
    updateDashboard();
  });
});

// ==== PRODUCTOS ====
function renderProductos() {
  const tbody = document.getElementById('tbody-productos');
  tbody.innerHTML = '';
  productos.forEach((p, i) => {
    tbody.innerHTML += `<tr>
      <td>${p.tipo || ''}</td>
      <td>${p.bodega || ''}</td>
      <td><input type='number' min='0' style='width:70px' value='${p.declarado}' onchange='actProdDeclarado(${i}, this.value)'></td>
      <td><input type='number' min='0' style='width:70px' value='${p.descargado}' onchange='actProdDescargado(${i}, this.value)'></td>
      <td><button type="button" onclick="eliminaProducto(${i})"><i class="fa fa-trash"></i></button></td>
    </tr>`;
  });
}

function actProdDeclarado(idx, vl) {
  productos[idx].declarado = Number(vl);
  renderProductos();
  updateDashboard();
}

function actProdDescargado(idx, vl) {
  productos[idx].descargado = Number(vl);
  renderProductos();
  updateDashboard();
}

function agregarProducto() {
  const tipo = document.getElementById('nuevo-producto-tipo').value;
  const bodega = document.getElementById('nuevo-producto-bodega').value;
  if (!tipo || !bodega) {
    alert('Debe seleccionar producto y bodega');
    return;
  }
  productos.push({ tipo: tipo, bodega: bodega, declarado: 0, descargado: 0 });
  renderProductos();
  updateDashboard();
  // Limpiar selects
  document.getElementById('nuevo-producto-tipo').value = '';
  document.getElementById('nuevo-producto-bodega').value = '';
}

function eliminaProducto(idx) {
  if(confirm('¿Eliminar este producto?')) {
    productos.splice(idx, 1);
    renderProductos();
    updateDashboard();
  }
}

// ==== PARADAS ====
function registrarParada(e) {
  e.preventDefault();
  let motivo = document.getElementById('parada-motivo').value;
  let bodega = document.getElementById('bodega-afectada').value;
  let ini = document.getElementById('parada-inicio').value;
  let fin = document.getElementById('parada-fin').value;
  
  paradas.push({ motivo, bodega, ini, fin });
  renderParadas();
  ajustarLaytimeLluvia();
  updateDashboard();
  e.target.reset();
  return false;
}

function renderParadas() {
  const tbody = document.getElementById('tbody-paradas');
  tbody.innerHTML = '';
  paradas.forEach((p, i) => {
    let duration = '', diff = 0;
    if (p.ini && p.fin) {
      const d1 = new Date(p.ini), d2 = new Date(p.fin);
      diff = (d2 - d1) / 3600000;
      duration = `${Math.floor(diff)}h ${Math.round((diff % 1) * 60)}m`;
    }
    tbody.innerHTML += `<tr>
      <td>${p.motivo}</td>
      <td>${p.bodega}</td>
      <td>${p.ini.replace('T', ' ')}</td>
      <td>${p.fin.replace('T', ' ')}</td>
      <td>${duration}</td>
      <td><button type="button" onclick="eliminaParada(${i})"><i class="fa fa-trash"></i></button></td>
    </tr>`;
  });
  let total = 0;
  paradas.forEach((p) => {
    if (p.ini && p.fin) total += (new Date(p.fin) - new Date(p.ini)) / 3600000;
  });
  document.getElementById('tiempo-paradas').innerText = total.toFixed(2) + ' h';
}

function eliminaParada(idx) {
  if(confirm('¿Eliminar esta parada?')) {
    paradas.splice(idx, 1);
    renderParadas();
    ajustarLaytimeLluvia();
    updateDashboard();
  }
}

// ==== CAMIONES ====
function registrarCamion(e) {
  e.preventDefault();
  let nlist = document.getElementById('camion-nlistado').value;
  let placa = document.getElementById('camion-placa').value;
  let ficha = document.getElementById('camion-ficha').value;
  let estatus = document.getElementById('camion-estatus').value;
  
  if (camiones.find((c) => c.nlist === nlist && (c.placa === placa || c.ficha === ficha))) {
    alert('Ya existe esa ficha o placa en ese listado');
    return false;
  }
  camiones.push({ nlist, placa, ficha, estatus });
  renderCamiones();
  e.target.reset();
  return false;
}

function renderCamiones() {
  const tbody = document.getElementById('tbody-camiones');
  tbody.innerHTML = '';
  let filtro = document.getElementById('filtro-estatus').value;
  let visibles = camiones.filter((c) => filtro === 'Todos' ? true : c.estatus === filtro);
  
  visibles.forEach((c, i) => {
    let icon = c.estatus === 'Cargado' ? 'fa-check-circle' : 'fa-times-circle';
    let idx = camiones.indexOf(c);
    tbody.innerHTML += `<tr>
      <td>${c.nlist}</td>
      <td>${c.placa}</td>
      <td>${c.ficha}</td>
      <td><span class="status-badge ${c.estatus === 'Cargado' ? 'cargado' : 'no-cargado'}"><i class="fa ${icon}"></i> ${c.estatus}</span></td>
      <td><button type="button" onclick="eliminaCamion(${idx})"><i class="fa fa-trash"></i></button></td>
    </tr>`;
  });
  document.getElementById('camion-total').innerText = camiones.length;
  let operacionHoras = calcOperacion() || 1;
  document.getElementById('camion-xhora').innerText = (camiones.length / Math.max(operacionHoras / 24, 0.1)).toFixed(1);
}

function eliminaCamion(idx) {
  if(confirm('¿Eliminar este camión?')) {
    camiones.splice(idx, 1);
    renderCamiones();
  }
}

function filtrarCamiones() {
  renderCamiones();
}

// ==== CORREA MECANIZADA ====
function registrarCorrea(e) {
  e.preventDefault();
  let linea = document.getElementById('correa-linea').value;
  let prod = document.getElementById('correa-producto').value;
  let tn = document.getElementById('correa-tn').value;
  let hora = document.getElementById('correa-hora').value;
  
  correa.push({ linea, prod, tn: Number(tn), hora });
  renderCorrea();
  updateDashboard();
  e.target.reset();
  return false;
}

function renderCorrea() {
  const tbody = document.getElementById('tbody-correa');
  tbody.innerHTML = '';
  correa.forEach((c, i) => {
    tbody.innerHTML += `<tr>
      <td>${c.linea}</td>
      <td>${c.prod}</td>
      <td>${c.tn}</td>
      <td>${c.hora.replace('T', ' ')}</td>
      <td><button type="button" onclick="eliminaCorrea(${i})"><i class="fa fa-trash"></i></button></td>
    </tr>`;
  });
  let total = correa.reduce((acc, c) => acc + c.tn, 0);
  document.getElementById('total-correa').innerText = total.toFixed(2);
}

function eliminaCorrea(idx) {
  if(confirm('¿Eliminar este registro?')) {
    correa.splice(idx, 1);
    renderCorrea();
    updateDashboard();
  }
}

// ==== MECANIZADO ====
function agregarLineaMec(e) {
  e.preventDefault();
  mecanizado.push({
    producto: document.getElementById('mec-producto').value,
    tn: Number(document.getElementById('mec-tn').value),
    hora: document.getElementById('mec-hora').value,
  });
  renderTablaMec();
  mostrarTonCamiones();
  e.target.reset();
  return false;
}

function renderTablaMec() {
  const tb = document.querySelector('#tabla-mec tbody');
  tb.innerHTML = '';
  mecanizado.forEach((m, i) => {
    tb.innerHTML += `<tr>
      <td>${m.producto}</td>
      <td>${m.tn}</td>
      <td>${m.hora}</td>
      <td><button type="button" onclick="eliminaMec(${i})"><i class="fa fa-trash"></i></button></td>
    </tr>`;
  });
  document.getElementById('total-mec').innerText = mecanizado.reduce((a, b) => a + b.tn, 0).toFixed(2);
}

function eliminaMec(idx) {
  if(confirm('¿Eliminar esta línea?')) {
    mecanizado.splice(idx, 1);
    renderTablaMec();
    mostrarTonCamiones();
  }
}

// ==== IMPORTAR TONELADAS CAMIONES ====
document.getElementById('import-camiones').addEventListener('change', function (evt) {
  const file = evt.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function (e) {
    try {
      const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
      const name = workbook.SheetNames[0];
      const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[name], { header: 1, defval: '' });
      procesarTonCamiones(sheet);
    } catch(err) {
      alert('Error al leer el archivo: ' + err.message);
    }
  };
  reader.readAsArrayBuffer(file);
});

function procesarTonCamiones(sheet) {
  let headerIdx = sheet.findIndex((row) =>
    row.includes('Fecha Entrada') && row.includes('Producto') && row.includes('Peso Neto (t)')
  );
  if (headerIdx == -1) {
    document.getElementById('res-ton-camiones').innerHTML = 'No se detectan encabezados válidos.';
    return;
  }
  let header = sheet[headerIdx];
  let idxFecha = header.findIndex((h) => h === 'Fecha Entrada');
  let idxProd = header.findIndex((h) => h === 'Producto');
  let idxPeso = header.findIndex((h) => h === 'Peso Neto (t)');
  let tabla = [];
  for (let i = headerIdx + 1; i < sheet.length; i++) {
    let row = sheet[i];
    if (!row[idxProd] || isNaN(parseFloat(row[idxPeso]))) continue;
    tabla.push({
      producto: row[idxProd],
      peso: parseFloat(row[idxPeso]),
      fecha: row[idxFecha],
    });
  }
  dataImport = tabla;
  mostrarTonCamiones();
}

function limpiarTonCamiones() {
  dataImport = [];
  horas = [];
  dataResumen = {};
  document.getElementById('res-ton-camiones').innerHTML = '';
  const ctx = document.getElementById('grafico-ton').getContext('2d');
  ctx.clearRect(0, 0, 950, 140);
  updateDashboard();
}

function mostrarTonCamiones() {
  let resumen = {}, resumenHora = {}, horasV = [];
  dataImport.forEach((r) => {
    let prod = r.producto, peso = r.peso;
    let hora = r.fecha && r.fecha.split(' ')[1] ? r.fecha.split(' ')[1].substring(0, 5) : '';
    resumen[prod] = (resumen[prod] || 0) + peso;
    if (!resumenHora[hora]) resumenHora[hora] = {};
    resumenHora[hora][prod] = (resumenHora[hora][prod] || 0) + peso;
    if (hora && !horasV.includes(hora)) horasV.push(hora);
  });
  
  let resumenMec = {}, resumenHoraMec = {};
  mecanizado.forEach((m) => {
    resumenMec[m.producto] = (resumenMec[m.producto] || 0) + m.tn;
    if (!resumenHoraMec[m.hora]) resumenHoraMec[m.hora] = {};
    resumenHoraMec[m.hora][m.producto] = (resumenHoraMec[m.hora][m.producto] || 0) + m.tn;
    if (m.hora && !horasV.includes(m.hora)) horasV.push(m.hora);
  });
  
  horasV = horasV.sort();
  dataResumen = resumen;
  horas = horasV;
  
  let html = '<table><thead><tr><th>Producto</th><th>Camión</th><th>Mecanizado</th><th>Total</th></tr></thead><tbody>';
  let sumaCamion = 0, sumaMec = 0;
  let todosProds = Array.from(new Set([...Object.keys(resumen), ...Object.keys(resumenMec)]));
  
  todosProds.forEach((prod) => {
    let valC = resumen[prod] || 0;
    let valM = resumenMec[prod] || 0;
    let ttl = valC + valM;
    sumaCamion += valC;
    sumaMec += valM;
    html += `<tr><td>${prod}</td><td>${valC.toFixed(2)}</td><td>${valM.toFixed(2)}</td><td>${ttl.toFixed(2)}</td></tr>`;
  });
  
  html += '</tbody></table><div style="margin-top:6px"><b>Total camión:</b> ' + sumaCamion.toFixed(2) + ' TM<br><b>Total mecanizado:</b> ' + sumaMec.toFixed(2) + ' TM<br><b>Total conjunto:</b> ' + (sumaCamion + sumaMec).toFixed(2) + ' TM</div>';
  document.getElementById('res-ton-camiones').innerHTML = html;
  document.getElementById('total-mec').innerText = sumaMec.toFixed(2);
  
  ultimoResumenGlobal = { tc: sumaCamion, tm: sumaMec, total: sumaCamion + sumaMec };
  updateDashboard();
  graficarTonCamiones(resumenHora, resumenHoraMec, horasV);
}

let ultimoResumenGlobal = { tc: 0, tm: 0, total: 0 };

function updateDashboard() {
  document.getElementById('dsh-tot-camion').innerText = ultimoResumenGlobal.tc.toFixed(2) + ' TM';
  document.getElementById('dsh-tot-mec').innerText = ultimoResumenGlobal.tm.toFixed(2) + ' TM';
  document.getElementById('dsh-tot-total').innerText = ultimoResumenGlobal.total.toFixed(2) + ' TM';
  
  calcOperacion();
  let neto = Math.max(tiempoBruto - tiempoParadas, 0);
  document.getElementById('dsh-tiempo-bruto').innerText = tiempoBruto.toFixed(2) + ' h';
  document.getElementById('dsh-tiempo-neto').innerText = neto.toFixed(2) + ' h';
  
  let tphBruto = tiempoBruto > 0 ? ultimoResumenGlobal.total / tiempoBruto : 0;
  let tphNeto = neto > 0 ? ultimoResumenGlobal.total / neto : 0;
  document.getElementById('dsh-tph').innerText = `${tphBruto.toFixed(1)} / ${tphNeto.toFixed(1)} TM/h`;
  
  let disponible = (laytimeAdjusted || 0) - (tiempoBruto || 0);
  document.getElementById('dsh-laytime-rest').innerText = (disponible > 0 ? disponible.toFixed(2) : '0') + ' horas';
}

function graficarTonCamiones(objHoras, objHorasMec, horasV) {
  let ctx = document.getElementById('grafico-ton').getContext('2d');
  ctx.clearRect(0, 0, 950, 140);
  
  if(horasV.length === 0) return;
  
  let colors = ['#28568d', '#bda25f', '#e4183a'];
  
  // Camiones barras azules
  horasV.forEach((hora, i) => {
    let suma = Object.values(objHoras[hora] || {}).reduce((a, b) => a + b, 0);
    let maxVal = Math.max(1, ...horasV.map((hh) => Object.values(objHoras[hh] || {}).reduce((a, b) => a + b, 0)));
    let x = 35 + i * 40;
    let y = 120 - (suma * 80) / maxVal;
    ctx.fillStyle = colors[0];
    ctx.fillRect(x, y, 15, 120 - y - 9);
  });
  
  // Mecanizado barras doradas
  horasV.forEach((hora, i) => {
    let suma = Object.values(objHorasMec[hora] || {}).reduce((a, b) => a + b, 0);
    let maxVal = Math.max(1, ...horasV.map((hh) => Object.values(objHorasMec[hh] || {}).reduce((a, b) => a + b, 0)));
    let x = 53 + i * 40;
    let y = 120 - (suma * 80) / maxVal;
    ctx.fillStyle = colors[1];
    ctx.fillRect(x, y, 15, 120 - y - 9);
  });
  
  // Total línea roja
  ctx.beginPath();
  ctx.strokeStyle = colors[2];
  ctx.lineWidth = 2;
  horasV.forEach((hora, i) => {
    let sumaCam = Object.values(objHoras[hora] || {}).reduce((a, b) => a + b, 0);
    let sumaMec = Object.values(objHorasMec[hora] || {}).reduce((a, b) => a + b, 0);
    let sumaTotal = sumaCam + sumaMec;
    let maxTotal = Math.max(1, ...horasV.map((hh) => 
      Object.values(objHoras[hh] || {}).reduce((a, b) => a + b, 0) + Object.values(objHorasMec[hh] || {}).reduce((a, b) => a + b, 0)
    ));
    let y = 120 - (sumaTotal * 80) / maxTotal;
    let x = 43 + i * 40;
    if (i == 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.stroke();
  
  // Etiquetas hora
  ctx.fillStyle = '#19324c';
  ctx.font = '11px Segoe UI';
  horasV.forEach((hora, i) => ctx.fillText(hora, 35 + i * 40, 134));
}

// Inicialización
document.addEventListener('DOMContentLoaded', () => {
  renderProductos();
  renderParadas();
  renderCamiones();
  renderCorrea();
  renderTablaMec();
  updateDashboard();
  console.log('Sistema inicializado correctamente');
});

// Actualización periódica cada 30 segundos
setInterval(updateDashboard, 30000);
</script>
</body>
</html>
