<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Trazabilidad de Descarga de Buques</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #2355a4;
      --secondary: #3498db;
      --success: #27ae60;
      --danger: #e74c3c;
      --warning: #f39c12;
      --light: #f5f7fa;
      --white: #fff;
      --surface: #f9fbfd;
      --card: #e6eef7;
      --border: #dbe3eb;
      --shadow: 0 2px 8px rgba(0,0,0,0.09);
      --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
      --radius: 14px;
      --radius-sm: 8px;
      --radius-xs: 6px;
    }
    * {margin:0;padding:0;box-sizing:border-box;}
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #19324c;
      overflow-x: hidden;
    }
    .login-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex; justify-content: center; align-items: center;
      z-index: 2000;
      backdrop-filter: blur(5px);
    }
    .login-modal {
      background: var(--white);
      padding: 3rem 2.5rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      text-align: center;
      max-width: 400px;
      width: 90%;
      animation: slideDown 0.4s ease-out;
    }
    @keyframes slideDown {
      from {opacity: 0; transform: translateY(-50px);}
      to {opacity:1; transform: translateY(0);}
    }
    .login-modal h2 {
      color: var(--primary);
      margin-bottom: 1.5rem;
      font-size: 1.8rem;
    }
    .login-modal input {
      width: 100%;
      padding: 0.8rem;
      margin-bottom: 1rem;
      border: 2px solid var(--border);
      border-radius: var(--radius-xs);
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    .login-modal input:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(35,85,164,0.1);
    }
    .login-modal button {
      width: 100%;
      padding: 0.9rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius-xs);
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .login-modal button:hover {
      background: var(--secondary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(35,85,164,0.3);
    }
    /* Aquí seguirían TODOS los estilos originales de tu plantilla, header, cards, secciones, animaciones, scroll, etc. */
  </style>
  <!-- FIREBASE INICIO -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAHCdzhcrgEhP9nke8cu7yL_aqgfVSzHWo",
      authDomain: "ojiva-gestion-descarga.firebaseapp.com",
      projectId: "ojiva-gestion-descarga",
      storageBucket: "ojiva-gestion-descarga.firebasestorage.app",
      messagingSenderId: "334520690865",
      appId: "1:334520690865:web:63f9658eb3fe3390709a90",
      measurementId: "G-EG030XNJP8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let currentUsername = '';
    // Aquí seguirán variables globales de tu app
  </script>
</head>
<body>
<div class="login-overlay" id="login-overlay">
  <div class="login-modal">
    <h2>Bienvenido a Ojiva</h2>
    <p style="font-size: 1.1rem;">Por favor, ingresa tu nombre de usuario para acceder</p>
    <input type="text" id="usernameInput" placeholder="Ingresa tu nombre..." />
    <button onclick="login()">Entrar</button>
  </div>
</div>
<header>
  <div class="header-left">
    <img src="logo.png" alt="Logo Ojiva" />
    <h1>Panel de Trazabilidad de Descarga de Buques</h1>
  </div>
  <div class="header-right">
    <div class="user-info">
      <i class="fa-solid fa-user"></i>
      <span id="user-name-display"></span>
    </div>
  </div>
</header>

<div class="main-container" id="main-container" style="display:none;">
  <nav>
    <button class="nav-button" onclick="mostrarVista('productos-view')"><i class="fa-solid fa-boxes-stacked"></i> Productos Manifestados</button>
    <button class="nav-button" onclick="mostrarVista('paradas-view')"><i class="fa-solid fa-stopwatch"></i> Registro de Paradas</button>
    <button class="nav-button" onclick="mostrarVista('camiones-view')"><i class="fa-solid fa-truck"></i> Tracking de Camiones</button>
    <button class="nav-button" onclick="mostrarVista('incidentes-view')"><i class="fa-solid fa-exclamation-triangle"></i> Incidentes</button>
    <button class="nav-button" onclick="mostrarVista('dashboard-view')"><i class="fa-solid fa-chart-simple"></i> Dashboard / Reportes</button>
  </nav>
  <div id="productos-view" class="view">
    <h2>Productos Manifestados</h2>
    <select id="nuevo-producto-tipo">
      <option value="">Seleccione producto...</option>
      <option value="Maz Americano">Maz Americano</option>
      <option value="Maz Argentino">Maz Argentino</option>
      <option value="Maz Brasileo">Maz Brasileo</option>
    </select>
    <select id="nuevo-producto-bodega">
      <option value="">Seleccione bodega...</option>
      <option value="1">Bodega 1</option>
      <option value="2">Bodega 2</option>
    </select>
    <button onclick="agregarProducto()" class="btn-main">Agregar Producto</button>
    <ul id="lista-productos"></ul>
  </div>

  <div id="paradas-view" class="view">
    <h2>Registro de Paradas</h2>
    <button onclick="agregarParada()" class="btn-main">Agregar Parada</button>
    <ul id="lista-paradas"></ul>
  </div>

  <div id="camiones-view" class="view">
    <h2>Tracking de Camiones</h2>
    <button onclick="agregarCamion()" class="btn-main">Agregar Camión</button>
    <ul id="lista-camiones"></ul>
  </div>

  <div id="incidentes-view" class="view">
    <h2>Registro de Incidentes</h2>
    <textarea id="descripcion-incidente" placeholder="Describa el incidente..." rows="4" style="width: 100%; margin-bottom: 10px;"></textarea>
    <button onclick="agregarIncidente()" class="btn-main">Registrar Incidente</button>
    <ul id="lista-incidentes"></ul>
  </div>

  <div id="dashboard-view" class="view">
    <h2>Dashboard / Reportes</h2>
    <div class="dashboard-grid">
      <div class="dashboard-card">
        <h4>Productos Declarados</h4>
        <canvas id="graficoProductos" width="300" height="150"></canvas>
      </div>
      <div class="dashboard-card">
        <h4>Paradas por Usuario</h4>
        <canvas id="graficoParadas" width="300" height="150"></canvas>
      </div>
    </div>
  </div>

  <button id="btnExportExcel" class="btn-main" style="margin: 1rem 0;">Exportar a Excel</button>
</div>
<script>
  let productos = [];
  let paradas = [];
  let camiones = [];
  let incidentes = [];

  function login() {
    const username = document.getElementById('usernameInput').value.trim();
    if (!username) {
      alert('Por favor ingresa tu nombre');
      return;
    }
    currentUsername = username;
    document.getElementById('login-overlay').style.display = 'none';
    document.getElementById('main-container').style.display = 'block';
    document.getElementById('user-name-display').innerText = currentUsername;
    cargarDatos();
    mostrarVista('productos-view');
  }

  function mostrarVista(id) {
    document.querySelectorAll('.view').forEach(view => {
      view.classList.remove('active');
    });
    document.getElementById(id).classList.add('active');
    if(id === 'dashboard-view'){ setTimeout(actualizarGraficos, 300);}
  }

  function cargarDatos() {
    cargarProductosDesdeFirebase();
    cargarParadasDesdeFirebase();
    cargarCamionesDesdeFirebase();
    cargarIncidentesDesdeFirebase();
  }

  function agregarProducto() {
    const tipo = document.getElementById('nuevo-producto-tipo').value;
    const bodega = document.getElementById('nuevo-producto-bodega').value;
    if (!tipo || !bodega) {
      alert('Debe seleccionar producto y bodega');
      return;
    }
    db.collection('productos').add({
      tipo,
      bodega,
      declarado: 0,
      descargado: 0,
      usuario: currentUsername,
      creadoEn: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => alert('Producto guardado!'));
  }
  function cargarProductosDesdeFirebase() {
    db.collection('productos')
      .orderBy('creadoEn', 'desc')
      .onSnapshot(snapshot => {
        productos = [];
        snapshot.forEach(doc => productos.push({ ...doc.data(), id: doc.id }));
        renderProductos();
      });
  }
  function renderProductos() {
    const ul = document.getElementById('lista-productos');
    if(!ul) return;
    ul.innerHTML = '';
    productos.forEach(p => {
      const li = document.createElement('li');
      li.textContent = `${p.tipo} - ${p.bodega} (Declarado: ${p.declarado}, Descargado: ${p.descargado})`;
      ul.appendChild(li);
    });
  }
  function agregarParada() {
    db.collection('paradas').add({
      usuario: currentUsername,
      creadoEn: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => alert('Parada registrada!'));
  }
  function cargarParadasDesdeFirebase() {
    db.collection('paradas')
      .orderBy('creadoEn', 'desc')
      .onSnapshot(snapshot => {
        paradas = [];
        snapshot.forEach(doc => paradas.push({ ...doc.data(), id: doc.id }));
        renderParadas();
      });
  }
  function renderParadas() {
    const ul = document.getElementById('lista-paradas');
    if(!ul) return;
    ul.innerHTML = '';
    paradas.forEach(p => {
      const li = document.createElement('li');
      li.textContent = `Parada: ${p.usuario} - ${p.creadoEn?.toDate()}`;
      ul.appendChild(li);
    });
  }
  function agregarCamion() {
    db.collection('camiones').add({
      usuario: currentUsername,
      creadoEn: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => alert('Camión registrado!'));
  }
  function cargarCamionesDesdeFirebase() {
    db.collection('camiones')
      .orderBy('creadoEn', 'desc')
      .onSnapshot(snapshot => {
        camiones = [];
        snapshot.forEach(doc => camiones.push({ ...doc.data(), id: doc.id }));
        renderCamiones();
      });
  }
  function renderCamiones() {
    const ul = document.getElementById('lista-camiones');
    if(!ul) return;
    ul.innerHTML = '';
    camiones.forEach(c => {
      const li = document.createElement('li');
      li.textContent = `Camión: ${c.usuario} - ${c.creadoEn?.toDate()}`;
      ul.appendChild(li);
    });
  }
  function agregarIncidente() {
    const descripcion = document.getElementById('descripcion-incidente').value.trim();
    if (!descripcion) {
      alert('Por favor, describa el incidente');
      return;
    }
    db.collection('incidentes').add({
      descripcion,
      usuario: currentUsername,
      creadoEn: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      alert('Incidente registrado!');
      document.getElementById('descripcion-incidente').value = '';
      cargarIncidentesDesdeFirebase();
    });
  }
  function cargarIncidentesDesdeFirebase() {
    db.collection('incidentes')
      .orderBy('creadoEn', 'desc')
      .onSnapshot(snapshot => {
        incidentes = [];
        snapshot.forEach(doc => incidentes.push({ ...doc.data(), id: doc.id }));
        renderIncidentes();
      });
  }
  function renderIncidentes() {
    const ul = document.getElementById('lista-incidentes');
    if(!ul) return;
    ul.innerHTML = '';
    incidentes.forEach(i => {
      const li = document.createElement('li');
      li.textContent = `${i.descripcion} - por ${i.usuario} en ${i.creadoEn?.toDate()}`;
      ul.appendChild(li);
    });
  }

  function actualizarGraficos() {
    crearGraficoProductos();
    crearGraficoParadas();
  }

  function crearGraficoProductos() {
    if(!document.getElementById('graficoProductos')) return;
    const ctx = document.getElementById('graficoProductos').getContext('2d');
    const tipos = [...new Set(productos.map(p => p.tipo))];
    const cantidades = tipos.map(tipo =>
      productos.filter(p => p.tipo === tipo).reduce((sum, p) => sum + (p.declarado || 0), 0)
    );
    if (window.chartProductos) window.chartProductos.destroy();

    window.chartProductos = new Chart(ctx, {
      type: "bar",
      data: {
        labels: tipos,
        datasets: [{
          label: "Productos Declarados",
          data: cantidades,
          backgroundColor: "#2355a4"
        }]
      },
    });
  }

  function crearGraficoParadas() {
    if(!document.getElementById('graficoParadas')) return;
    const ctx2 = document.getElementById("graficoParadas").getContext("2d");
    const usuarios = [...new Set(paradas.map((p) => p.usuario))];
    const cantidades = usuarios.map(
      (usuario) => paradas.filter((p) => p.usuario === usuario).length
    );
    if (window.chartParadas) window.chartParadas.destroy();

    window.chartParadas = new Chart(ctx2, {
      type: "pie",
      data: {
        labels: usuarios,
        datasets: [{
          label: "Paradas por usuario",
          data: cantidades,
          backgroundColor: [
            "#2355a4", "#3498db", "#27ae60", "#e74c3c", "#f39c12", "#bdbdbd"
          ]
        }]
      },
    });
  }

  document.getElementById("btnExportExcel").addEventListener("click", () => {
    let wb = XLSX.utils.book_new();

    let wsProductos = XLSX.utils.json_to_sheet(
      productos.map((p) => ({
        tipo: p.tipo,
        bodega: p.bodega,
        declarado: p.declarado,
        descargado: p.descargado,
        usuario: p.usuario,
        creadoEn: p.creadoEn
          ? new Date(p.creadoEn.seconds * 1000).toLocaleString()
          : "",
      }))
    );
    XLSX.utils.book_append_sheet(wb, wsProductos, "Productos");

    let wsParadas = XLSX.utils.json_to_sheet(
      paradas.map((p) => ({
        usuario: p.usuario,
        creadoEn: p.creadoEn ? new Date(p.creadoEn.seconds * 1000).toLocaleString() : "",
      }))
    );
    XLSX.utils.book_append_sheet(wb, wsParadas, "Paradas");

    let wsCamiones = XLSX.utils.json_to_sheet(
      camiones.map((c) => ({
        usuario: c.usuario,
        creadoEn: c.creadoEn ? new Date(c.creadoEn.seconds * 1000).toLocaleString() : "",
      }))
    );
    XLSX.utils.book_append_sheet(wb, wsCamiones, "Camiones");

    let wsIncidentes = XLSX.utils.json_to_sheet(
      incidentes.map((i) => ({
        descripcion: i.descripcion,
        usuario: i.usuario,
        creadoEn: i.creadoEn ? new Date(i.creadoEn.seconds * 1000).toLocaleString() : "",
      }))
    );
    XLSX.utils.book_append_sheet(wb, wsIncidentes, "Incidentes");

    XLSX.writeFile(wb, "gestion_descarga.xlsx");
  });

</script>
</body>
</html>

