<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Trazabilidad de Descarga de Buques</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2355a4;
      --secondary: #3498db;
      --success: #27ae60;
      --danger: #e74c3c;
      --warning: #f39c12;
      --light: #f5f7fa;
      --white: #fff;
      --surface: #f9fbfd;
      --card: #e6eef7;
      --border: #dbe3eb;
      --shadow: 0 2px 8px rgba(0,0,0,0.09);
      --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
      --radius: 14px;
      --radius-sm: 8px;
      --radius-xs: 6px;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #19324c;
      overflow-x: hidden;
    }

    /* Modal de Login */
    .login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      backdrop-filter: blur(5px);
    }

    .login-modal {
      background: var(--white);
      padding: 3rem 2.5rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      text-align: center;
      max-width: 400px;
      width: 90%;
      animation: slideDown 0.4s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .login-modal h2 {
      color: var(--primary);
      margin-bottom: 1.5rem;
      font-size: 1.8rem;
    }

    .login-modal i.fa-user-circle {
      font-size: 4rem;
      color: var(--primary);
      margin-bottom: 1.5rem;
    }

    .login-modal input {
      width: 100%;
      padding: 0.8rem;
      margin-bottom: 1rem;
      border: 2px solid var(--border);
      border-radius: var(--radius-xs);
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    .login-modal input:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(35, 85, 164, 0.1);
    }

    .login-modal button {
      width: 100%;
      padding: 0.9rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius-xs);
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .login-modal button:hover {
      background: var(--secondary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(35, 85, 164, 0.3);
    }
    
    /* Header con navegaci√≥n */
    header {
      background: linear-gradient(135deg, var(--primary), #102842 65%);
      color: var(--white);
      padding: 1rem 2rem;
      box-shadow: var(--shadow-lg);
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .header-left img {
      height: 45px;
      border-radius: var(--radius-sm);
      background: #fff;
      padding: 6px;
    }
    
    .header-left h1 {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: rgba(255, 255, 255, 0.15);
      padding: 0.5rem 1rem;
      border-radius: var(--radius-xs);
    }

    .user-info i {
      font-size: 1.2rem;
    }
    
    .nav-button, .export-button {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 0.6rem 1.2rem;
      border-radius: var(--radius-xs);
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
    }
    
    .nav-button:hover, .export-button:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }

    .export-button {
      background: var(--success);
    }

    .export-button:hover {
      background: #1e8449;
    }
    
    /* Contenedor principal */
    .main-container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 1rem;
      position: relative;
    }
    
    /* Vista de secciones */
    .view {
      display: none;
      opacity: 0;
      transform: perspective(1000px) rotateY(-10deg);
      transition: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    .view.active {
      display: block;
      opacity: 1;
      transform: perspective(1000px) rotateY(0deg);
      animation: slideInView 0.6s ease-out;
    }
    
    @keyframes slideInView {
      from {
        opacity: 0;
        transform: perspective(1000px) rotateY(-15deg) translateX(-50px);
      }
      to {
        opacity: 1;
        transform: perspective(1000px) rotateY(0deg) translateX(0);
      }
    }
    
    /* HOME - Grid de iconos */
    .home-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 2rem;
      padding: 2rem;
    }
    
    .home-card {
      background: var(--white);
      border-radius: var(--radius);
      padding: 2.5rem 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }
    
    .home-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      opacity: 0;
      transition: opacity 0.4s ease;
      z-index: 0;
    }
    
    .home-card:hover {
      transform: translateY(-15px) scale(1.05);
      box-shadow: var(--shadow-lg);
    }
    
    .home-card:hover::before {
      opacity: 0.1;
    }
    
    .home-card:active {
      transform: translateY(-10px) scale(1.02);
    }
    
    .home-card-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      color: var(--primary);
      transition: all 0.3s ease;
      position: relative;
      z-index: 1;
    }
    
    .home-card:hover .home-card-icon {
      transform: rotateY(360deg) scale(1.2);
      color: var(--secondary);
    }
    
    .home-card h3 {
      font-size: 1.3rem;
      margin-bottom: 0.5rem;
      color: var(--primary);
      position: relative;
      z-index: 1;
    }
    
    .home-card p {
      color: #666;
      font-size: 0.95rem;
      position: relative;
      z-index: 1;
    }
    
    /* Contenedor de contenido */
    .content-wrapper {
      background: var(--white);
      border-radius: var(--radius);
      padding: 2rem;
      box-shadow: var(--shadow-lg);
      animation: fadeInUp 0.5s ease-out;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--border);
    }

    .section-header-left {
      display: flex;
      align-items: center;
    }
    
    .section-header i {
      font-size: 1.8rem;
      margin-right: 0.8rem;
      color: var(--primary);
    }
    
    .section-header h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary);
    }

    .section-export-btn {
      background: var(--success);
      color: white;
      padding: 0.6rem 1rem;
      border: none;
      border-radius: var(--radius-xs);
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
    }

    .section-export-btn:hover {
      background: #1e8449;
      transform: translateY(-2px);
    }
    
    /* Estilos de formularios */
    label {
      font-weight: 500;
      margin-right: 5px;
      display: block;
      margin-bottom: 0.3rem;
      color: #555;
    }
    
    input, select, button, textarea {
      margin-bottom: 0.8rem;
      padding: 0.6rem;
      border-radius: var(--radius-xs);
      border: 1px solid #ccd2db;
      font-size: 1em;
      outline: none;
      transition: all 0.2s ease;
      width: 100%;
    }
    
    input:focus, select:focus, textarea:focus {
      box-shadow: 0 0 0 3px rgba(35, 85, 164, 0.1);
      border-color: var(--primary);
    }
    
    button {
      background: var(--primary);
      color: var(--white);
      cursor: pointer;
      border: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.7rem 1.5rem;
      transition: all 0.3s ease;
      width: auto;
    }
    
    button:hover {
      background: var(--secondary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(35, 85, 164, 0.3);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .icon-btn {
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
    }
    
    .icon-btn:hover {
      background: var(--primary);
      color: white;
    }
    
    /* Tablas */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: var(--white);
      border-radius: var(--radius-xs);
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    
    th, td {
      border: 1px solid #e0e0e0;
      padding: 0.8rem;
      text-align: left;
    }
    
    th {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
    }
    
    tr:hover td {
      background: #f0f8ff;
    }
    
    .flex-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .flex-col-2 {
      display: flex;
      flex-direction: column;
    }
    
    .summary {
      margin-top: 1rem;
      background: linear-gradient(135deg, #e1eaf6, #d4e3f7);
      padding: 1.2rem;
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow);
    }
    
    .dashboard-card {
      background: linear-gradient(135deg, #ffffff, #f0f7ff);
      margin: 1rem 0;
      border-radius: var(--radius-sm);
      padding: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      border-left: 4px solid var(--primary);
    }
    
    .dashboard-card:hover {
      transform: translateX(5px);
      box-shadow: var(--shadow-lg);
    }
    
    .kpi-icon {
      font-size: 2.5rem;
      color: var(--primary);
    }
    
    .kpi-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--success);
      margin-left: auto;
    }
    
    .status-badge {
      padding: 0.3em 0.8em;
      border-radius: 20px;
      color: #fff;
      font-size: 0.9em;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-weight: 600;
    }
    
    .cargado {
      background: linear-gradient(135deg, var(--success), #1e8449);
    }
    
    .no-cargado {
      background: linear-gradient(135deg, var(--danger), #c0392b);
    }
    
    .legend {
      margin: 15px 0;
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .legend span {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      display: inline-block;
    }

    .user-badge {
      display: inline-block;
      background: #e8f4f8;
      color: var(--primary);
      padding: 0.2em 0.6em;
      border-radius: 12px;
      font-size: 0.85em;
      font-weight: 500;
      margin-left: 0.5rem;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .home-grid {
        grid-template-columns: 1fr;
      }
      
      .flex-row {
        grid-template-columns: 1fr;
      }
      
      header {
        flex-direction: column;
        gap: 1rem;
      }
      
      .header-left h1 {
        font-size: 1.1rem;
      }

      .header-right {
        flex-wrap: wrap;
        justify-content: center;
      }
    }
  </style>
</head>
<body>

<!-- Modal de Login -->
<div id="loginOverlay" class="login-overlay">
  <div class="login-modal">
    <i class="fas fa-user-circle"></i>
    <h2>Iniciar Sesi√≥n</h2>
    <p style="color: #666; margin-bottom: 1.5rem;">Ingresa tu nombre para continuar</p>
    <input type="text" id="usernameInput" placeholder="Nombre de usuario" autocomplete="off">
    <button onclick="login()"><i class="fas fa-sign-in-alt"></i> Ingresar</button>
  </div>
</div>

<header>
  <div class="header-left">
    <img src="image.jpg" alt="Logo" />
    <h1><i class="fas fa-ship"></i> Panel de Trazabilidad de Descarga</h1>
  </div>
  <div class="header-right">
    <div class="user-info">
      <i class="fas fa-user"></i>
      <span id="currentUser"></span>
    </div>
    <button class="export-button" onclick="exportarTodoExcel()">
      <i class="fas fa-file-excel"></i> Exportar Todo a Excel
    </button>
    <button class="nav-button" onclick="showView('home')">
      <i class="fas fa-home"></i> Inicio
    </button>
    <button class="nav-button" onclick="cerrarSesion()">
      <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
    </button>
  </div>
</header>

<div class="main-container">
  
  <!-- HOME VIEW -->
  <div id="home" class="view active">
    <div class="home-grid">
      <div class="home-card" onclick="showView('info-general')">
        <i class="fas fa-ship home-card-icon"></i>
        <h3>Informaci√≥n General</h3>
        <p>Datos del buque, ETA, laytime y operaciones</p>
      </div>
      
      <div class="home-card" onclick="showView('productos')">
        <i class="fas fa-boxes home-card-icon"></i>
        <h3>Productos Manifestados</h3>
        <p>Gesti√≥n de productos declarados y descargados</p>
      </div>
      
      <div class="home-card" onclick="showView('paradas')">
        <i class="fas fa-clock home-card-icon"></i>
        <h3>Registro de Paradas</h3>
        <p>Incidentes y tiempo de paradas</p>
      </div>
      
      <div class="home-card" onclick="showView('camiones')">
        <i class="fas fa-truck home-card-icon"></i>
        <h3>Tracking de Camiones</h3>
        <p>Seguimiento de camiones y estatus</p>
      </div>
      
      <div class="home-card" onclick="showView('correa')">
        <i class="fas fa-cogs home-card-icon"></i>
        <h3>Correa Mecanizada</h3>
        <p>Registro por l√≠nea y hora</p>
      </div>
      
      <div class="home-card" onclick="showView('toneladas')">
        <i class="fas fa-file-excel home-card-icon"></i>
        <h3>Toneladas Camiones</h3>
        <p>Importar datos y mecanizado</p>
      </div>
      
      <div class="home-card" onclick="showView('dashboard')">
        <i class="fas fa-chart-line home-card-icon"></i>
        <h3>Dashboard Ejecutivo</h3>
        <p>KPIs y an√°lisis completo</p>
      </div>
    </div>
  </div>

  <!-- INFORMACI√ìN GENERAL -->
  <div id="info-general" class="view">
    <div class="content-wrapper">
      <div class="section-header">
        <div class="section-header-left">
          <i class="fas fa-ship"></i>
          <h2>Informaci√≥n General del Buque</h2>
        </div>
        <button class="section-export-btn" onclick="exportarSeccion('info-general')">
          <i class="fas fa-file-excel"></i> Exportar
        </button>
      </div>
      <div class="flex-row">
        <div class="flex-col-2">
          <label><i class="fa fa-id-card"></i> Nombre:</label>
          <input id="buque-nombre">
        </div>
        <div class="flex-col-2">
          <label><i class="fa fa-calendar"></i> ETA:</label>
          <input type="datetime-local" id="buque-eta">
        </div>
        <div class="flex-col-2">
          <label><i class="fa fa-calendar-plus"></i> Fecha NOR:</label>
          <input type="datetime-local" id="buque-nor">
        </div>
        <div class="flex-col-2">
          <label><i class="fa fa-tags"></i> Rata Contratada TM/d√≠a:</label>
          <input type="number" id="buque-rata" min="1">
        </div>
        <div class="flex-col-2">
          <label><i class="fa fa-file-alt"></i> Condici√≥n Contrato:</label>
          <select id="buque-condicion">
            <option value="SHINC">SHINC</option>
            <option value="SHEX">SHEX</option>
          </select>
        </div>
        <div class="flex-col-2">
          <label><i class="fa fa-weight-scale"></i> Total Producto (TM):</label>
          <input type="number" id="buque-tm" min="0">
        </div>
        <div class="flex-col-2">
          <label><i class="fa fa-play"></i> Inicio Operaci√≥n:</label>
          <input type="datetime-local" id="inicio-op">
        </div>
        <div class="flex-col-2">
          <label><i class="fa fa-stop"></i> Fin Operaci√≥n:</label>
          <input type="datetime-local" id="fin-op">
        </div>
      </div>
      <div class="summary">
        <div><b>Laytime Disponible:</b> <span id="laytime">0 horas</span></div>
        <div><b>Tiempo en Operaci√≥n:</b> <span id="tiempo-operacion">No iniciado</span></div>
      </div>
    </div>
  </div>

  <!-- PRODUCTOS MANIFESTADOS -->
  <div id="productos" class="view">
    <div class="content-wrapper">
      <div class="section-header">
        <div class="section-header-left">
          <i class="fas fa-boxes"></i>
          <h2>Productos Manifestados</h2>
        </div>
        <button class="section-export-btn" onclick="exportarSeccion('productos')">
          <i class="fas fa-file-excel"></i> Exportar
        </button>
      </div>
      <div class="flex-row">
        <select id="nuevo-producto-tipo">
          <option value="">Seleccione producto...</option>
          <option value="Ma√≠z Americano">Ma√≠z Americano</option>
          <option value="Ma√≠z Argentino">Ma√≠z Argentino</option>
          <option value="Ma√≠z Brasile√±o">Ma√≠z Brasile√±o</option>
          <option value="DNS">DNS</option>
          <option value="HRW">HRW</option>
          <option value="SRW">SRW</option>
          <option value="Frijol">Frijol</option>
          <option value="Cascarilla">Cascarilla</option>
          <option value="Aceite de Palma">Aceite de Palma</option>
          <option value="Palmite">Palmite</option>
        </select>
        <select id="nuevo-producto-bodega">
          <option value="">Seleccione bodega...</option>
          <option value="1">Bodega 1</option>
          <option value="2">Bodega 2</option>
          <option value="3">Bodega 3</option>
          <option value="4">Bodega 4</option>
          <option value="5">Bodega 5</option>
          <option value="6">Bodega 6</option>
        </select>
        <button type="button" onclick="agregarProducto()">
          <i class="fa fa-plus-circle"></i> Agregar
        </button>
      </div>
      <table id="tabla-productos">
        <thead>
          <tr>
            <th><i class="fa fa-box"></i> Producto</th>
            <th><i class="fa fa-warehouse"></i> Bodega</th>
            <th><i class="fa fa-clipboard-list"></i> Declarado (TM)</th>
            <th><i class="fa fa-truck-loading"></i> Descargado (TM)</th>
            <th><i class="fa fa-user"></i> Usuario</th>
            <th><i class="fa fa-trash-alt"></i> Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="tbody-productos"></tbody>
      </table>
    </div>
  </div>

  <!-- REGISTRO DE PARADAS -->
  <div id="paradas" class="view">
    <div class="content-wrapper">
      <div class="section-header">
        <div class="section-header-left">
          <i class="fas fa-clock"></i>
          <h2>Registro de Paradas / Incidentes</h2>
        </div>
        <button class="section-export-btn" onclick="exportarSeccion('paradas')">
          <i class="fas fa-file-excel"></i> Exportar
        </button>
      </div>
      <form onsubmit="registrarParada(event)">
        <div class="flex-row">
          <div class="flex-col-2">
            <label><i class="fa fa-exclamation-triangle"></i> Motivo:</label>
            <select required id="parada-motivo">
              <option value="">Elija‚Ä¶</option>
              <option value="LLUVIA">LLUVIA</option>
              <option value="NO CAMIONES">NO CAMIONES</option>
              <option value="MOVIMIENTO BARCO">MOVIMIENTO BARCO</option>
              <option value="MECANIZADO FALLA">MECANIZADO FALLA</option>
              <option value="BUQUE INTERNO FALLA">BUQUE INTERNO FALLA</option>
              <option value="OTROS">OTROS</option>
            </select>
          </div>
          <div class="flex-col-2">
            <label><i class="fa fa-warehouse"></i> Bodega Afectada</label>
            <select id="bodega-afectada">
              <option value="1">Bodega 1</option>
              <option value="2">Bodega 2</option>
              <option value="3">Bodega 3</option>
              <option value="4">Bodega 4</option>
              <option value="5">Bodega 5</option>
              <option value="6">Bodega 6</option>
              <option value="Completo">Completo</option>
            </select>
          </div>
          <div class="flex-col-2">
            <label><i class="fa fa-play-circle"></i> Inicio:</label>
            <input required type="datetime-local" id="parada-inicio">
          </div>
          <div class="flex-col-2">
            <label><i class="fa fa-stop-circle"></i> Fin:</label>
            <input required type="datetime-local" id="parada-fin">
          </div>
        </div>
        <button type="submit"><i class="fa fa-plus"></i> Registrar Parada</button>
      </form>
      <table id="tabla-paradas">
        <thead>
          <tr>
            <th><i class="fa fa-bolt"></i> Motivo</th>
            <th><i class="fa fa-warehouse"></i> Bodega</th>
            <th><i class="fa fa-play"></i> Inicio</th>
            <th><i class="fa fa-stop"></i> Fin</th>
            <th><i class="fa fa-history"></i> Duraci√≥n</th>
            <th><i class="fa fa-user"></i> Usuario</th>
            <th><i class="fa fa-trash-alt"></i> Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="tbody-paradas"></tbody>
      </table>
      <div class="summary">
        <b>Tiempo Total Paradas:</b> <span id="tiempo-paradas">0.00 h</span>
      </div>
    </div>
  </div>

  <!-- TRACKING DE CAMIONES -->
  <div id="camiones" class="view">
    <div class="content-wrapper">
      <div class="section-header">
        <div class="section-header-left">
          <i class="fas fa-truck"></i>
          <h2>Tracking de Camiones</h2>
        </div>
        <button class="section-export-btn" onclick="exportarSeccion('camiones')">
          <i class="fas fa-file-excel"></i> Exportar
        </button>
      </div>
      <form onsubmit="registrarCamion(event)">
        <div class="flex-row">
          <div class="flex-col-2">
            <label><i class="fa fa-list-ol"></i> Listado:</label>
            <input required id="camion-nlistado" type="number" min="1">
          </div>
          <div class="flex-col-2">
            <label><i class="fa fa-id-badge"></i> Placa:</label>
            <input required id="camion-placa">
          </div>
          <div class="flex-col-2">
            <label><i class="fa fa-file-signature"></i> Ficha:</label>
            <input required id="camion-ficha">
          </div>
          <div class="flex-col-2">
            <label><i class="fa fa-clipboard-check"></i> Estatus:</label>
            <select id="camion-estatus">
              <option value="Cargado">Cargado</option>
              <option value="No Cargado">No Cargado</option>
            </select>
          </div>
        </div>
        <button type="submit"><i class="fa fa-save"></i> Registrar Cami√≥n</button>
      </form>
      <div style="margin: 1rem 0;">
        <label><i class="fa fa-filter"></i> Filtrar por Estatus:</label>
        <select onchange="filtrarCamiones()" id="filtro-estatus" style="width: auto; display: inline-block;">
          <option value="Todos">Todos</option>
          <option value="Cargado">Cargado</option>
          <option value="No Cargado">No Cargado</option>
        </select>
      </div>
      <table id="tabla-camiones">
        <thead>
          <tr>
            <th><i class="fa fa-list-ol"></i> Listado</th>
            <th><i class="fa fa-id-badge"></i> Placa</th>
            <th><i class="fa fa-file-signature"></i> Ficha</th>
            <th><i class="fa fa-clipboard-check"></i> Estatus</th>
            <th><i class="fa fa-user"></i> Usuario</th>
            <th><i class="fa fa-trash-alt"></i> Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="tbody-camiones"></tbody>
      </table>
      <div class="summary">
        <span><i class="fa fa-truck"></i> <b>Camiones registrados:</b> <span id="camion-total">0</span></span>
        <span style="margin-left:25px;"><i class="fa fa-clock"></i> <b>Camiones por hora:</b> <span id="camion-xhora">0.0</span></span>
      </div>
    </div>
  </div>

  <!-- CORREA MECANIZADA -->
  <div id="correa" class="view">
    <div class="content-wrapper">
      <div class="section-header">
        <div class="section-header-left">
          <i class="fas fa-cogs"></i>
          <h2>Correa Mecanizada</h2>
        </div>
        <button class="section-export-btn" onclick="exportarSeccion('correa')">
          <i class="fas fa-file-excel"></i> Exportar
        </button>
      </div>
      <form onsubmit="registrarCorrea(event)">
        <div class="flex-row">
          <div class="flex-col-2">
            <label><i class="fa fa-project-diagram"></i> L√≠nea:</label>
            <select id="correa-linea">
              <option value="1">L√≠nea 1</option>
              <option value="2">L√≠nea 2</option>
            </select>
          </div>
          <div class="flex-col-2">
            <label><i class="fa fa-box"></i> Producto:</label>
            <input required id="correa-producto">
          </div>
          <div class="flex-col-2">
            <label><i class="fa fa-balance-scale-left"></i> Toneladas:</label>
            <input required type="number" id="correa-tn" min="1">
          </div>
          <div class="flex-col-2">
            <label><i class="fa fa-clock"></i> Hora:</label>
            <input required type="datetime-local" id="correa-hora">
          </div>
        </div>
        <button type="submit"><i class="fa fa-plus"></i> Registrar</button>
      </form>
      <table id="tabla-correa">
        <thead>
          <tr>
            <th><i class="fa fa-project-diagram"></i> L√≠nea</th>
            <th><i class="fa fa-box"></i> Producto</th>
            <th><i class="fa fa-balance-scale-left"></i> Toneladas</th>
            <th><i class="fa fa-clock"></i> Hora</th>
            <th><i class="fa fa-user"></i> Usuario</th>
            <th><i class="fa fa-trash-alt"></i> Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="tbody-correa"></tbody>
      </table>
      <div class="summary">
        <b><i class="fa fa-box"></i> Total Descargado por Correa:</b> <span id="total-correa">0.00</span> TM
      </div>
    </div>
  </div>

  <!-- TONELADAS CAMIONES -->
  <div id="toneladas" class="view">
    <div class="content-wrapper">
      <div class="section-header">
        <div class="section-header-left">
          <i class="fas fa-file-excel"></i>
          <h2>Toneladas Camiones</h2>
        </div>
        <button class="section-export-btn" onclick="exportarSeccion('toneladas')">
          <i class="fas fa-file-excel"></i> Exportar
        </button>
      </div>
      <div style="margin-bottom: 1rem;">
        <input type="file" id="import-camiones" accept=".xlsx,.xls"/>
        <button onclick="limpiarTonCamiones()" type="button" class="icon-btn">
          <i class="fa fa-trash"></i> Limpiar datos
        </button>
      </div>
      <h3 style="margin-top: 2rem;"><i class="fa fa-cogs"></i> Mecanizado (Agregar l√≠neas)</h3>
      <form onsubmit="agregarLineaMec(event)" style="margin-bottom: 1rem;">
        <div class="flex-row">
          <input id="mec-producto" placeholder="Producto" required />
          <input id="mec-tn" type="number" placeholder="Toneladas" min="0.01" step="0.01" required style="width: auto;" />
          <input id="mec-hora" type="time" required style="width: auto;" />
          <button type="submit"><i class="fa fa-plus"></i> Agregar</button>
        </div>
      </form>
      <table id="tabla-mec">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Toneladas</th>
            <th>Hora</th>
            <th>Usuario</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div style="margin-top: 1rem;">
        <b>Total mecanizado:</b> <span id="total-mec">0.00</span> TM
      </div>
      <div id="res-ton-camiones"></div>
      <canvas id="grafico-ton" width="950" height="140"></canvas>
      <div class="legend">
        <div class="legend-item"><span style="background: #28568d"></span> Camiones</div>
        <div class="legend-item"><span style="background: #bda25f"></span> Mecanizado</div>
        <div class="legend-item"><span style="background: #e4183a"></span> Total conjunto</div>
      </div>
    </div>
  </div>

  <!-- DASHBOARD EJECUTIVO -->
  <div id="dashboard" class="view">
    <div class="content-wrapper">
      <div class="section-header">
        <div class="section-header-left">
          <i class="fas fa-chart-line"></i>
          <h2>Dashboard Ejecutivo</h2>
        </div>
        <button class="section-export-btn" onclick="exportarSeccion('dashboard')">
          <i class="fas fa-file-excel"></i> Exportar
        </button>
      </div>
      <div class="dashboard-card">
        <i class="fa fa-truck kpi-icon"></i>
        <span><b>Descarga Cami√≥n:</b></span>
        <span class="kpi-value" id="dsh-tot-camion">0.00 TM</span>
      </div>
      <div class="dashboard-card">
        <i class="fa fa-cogs kpi-icon"></i>
        <span><b>Descarga Mecanizado:</b></span>
        <span class="kpi-value" id="dsh-tot-mec">0.00 TM</span>
      </div>
      <div class="dashboard-card">
        <i class="fa fa-layer-group kpi-icon"></i>
        <span><b>Total Global:</b></span>
        <span class="kpi-value" id="dsh-tot-total">0.00 TM</span>
      </div>
      <div class="dashboard-card">
        <i class="fa fa-clock kpi-icon"></i>
        <span><b>Tiempo Bruto:</b></span>
        <span class="kpi-value" id="dsh-tiempo-bruto">0.00 h</span>
      </div>
      <div class="dashboard-card">
        <i class="fa fa-stopwatch kpi-icon"></i>
        <span><b>Tiempo Neto:</b></span>
        <span class="kpi-value" id="dsh-tiempo-neto">0.00 h</span>
      </div>
      <div class="dashboard-card">
        <i class="fa fa-chart-line kpi-icon"></i>
        <span><b>TPH Promedio:</b></span>
        <span class="kpi-value" id="dsh-tph">0.0 / 0.0</span>
      </div>
      <div class="dashboard-card">
        <i class="fa fa-calendar-minus kpi-icon"></i>
        <span><b>Laytime Restante:</b></span>
        <span class="kpi-value" id="dsh-laytime-rest">0 h</span>
      </div>
    </div>
  </div>

</div>

<script>
// ==== SISTEMA DE AUTENTICACI√ìN ====
let currentUsername = '';

function login() {
  const username = document.getElementById('usernameInput').value.trim();
  if (!username) {
    alert('Por favor ingresa tu nombre');
    return;
  }
  currentUsername = username;
  document.getElementById('currentUser').innerText = username;
  document.getElementById('loginOverlay').style.display = 'none';
  cargarDatosGuardados();
}

function cerrarSesion() {
  if(confirm('¬øCerrar sesi√≥n?')) {
    currentUsername = '';
    document.getElementById('loginOverlay').style.display = 'flex';
    document.getElementById('usernameInput').value = '';
  }
}

// Prevenir Enter en login
document.getElementById('usernameInput').addEventListener('keypress', function(e) {
  if(e.key === 'Enter') {
    login();
  }
});

// ==== NAVEGACI√ìN ENTRE VISTAS ====
function showView(viewId) {
  const views = document.querySelectorAll('.view');
  views.forEach(view => {
    view.classList.remove('active');
  });
  
  setTimeout(() => {
    document.getElementById(viewId).classList.add('active');
  }, 100);
}

// ==== VARIABLES GLOBALES ====
let productos = [], paradas = [], camiones = [], correa = [], mecanizado = [];
let laytimeHoras = 0, laytimeAdjusted = 0;
let dataImport = [], dataResumen = {}, horas = [];
let tiempoBruto = 0, tiempoParadas = 0, tiempoLluvia = 0;

// ==== GUARDAR Y CARGAR DATOS (LocalStorage) ====
function guardarDatos() {
  const datos = {
    productos, paradas, camiones, correa, mecanizado,
    buqueNombre: document.getElementById('buque-nombre').value,
    buqueEta: document.getElementById('buque-eta').value,
    buqueNor: document.getElementById('buque-nor').value,
    buqueRata: document.getElementById('buque-rata').value,
    buqueCondicion: document.getElementById('buque-condicion').value,
    buqueTm: document.getElementById('buque-tm').value,
    inicioOp: document.getElementById('inicio-op').value,
    finOp: document.getElementById('fin-op').value,
  };
  localStorage.setItem('trazabilidadBuques', JSON.stringify(datos));
}

function cargarDatosGuardados() {
  const datosGuardados = localStorage.getItem('trazabilidadBuques');
  if (datosGuardados) {
    const datos = JSON.parse(datosGuardados);
    productos = datos.productos || [];
    paradas = datos.paradas || [];
    camiones = datos.camiones || [];
    correa = datos.correa || [];
    mecanizado = datos.mecanizado || [];
    
    document.getElementById('buque-nombre').value = datos.buqueNombre || '';
    document.getElementById('buque-eta').value = datos.buqueEta || '';
    document.getElementById('buque-nor').value = datos.buqueNor || '';
    document.getElementById('buque-rata').value = datos.buqueRata || '';
    document.getElementById('buque-condicion').value = datos.buqueCondicion || 'SHINC';
    document.getElementById('buque-tm').value = datos.buqueTm || '';
    document.getElementById('inicio-op').value = datos.inicioOp || '';
    document.getElementById('fin-op').value = datos.finOp || '';
    
    renderProductos();
    renderParadas();
    renderCamiones();
    renderCorrea();
    renderTablaMec();
    calcLaytime();
    updateDashboard();
  }
}

// ==== EXPORTAR A EXCEL ====
function exportarTodoExcel() {
  const wb = XLSX.utils.book_new();
  
  // Hoja 1: Informaci√≥n General
  const infoGeneral = [[
    'Nombre Buque', 'ETA', 'Fecha NOR', 'Rata Contratada', 'Condici√≥n', 
    'Total Producto (TM)', 'Inicio Operaci√≥n', 'Fin Operaci√≥n', 'Laytime', 'Tiempo Operaci√≥n'
  ], [
    document.getElementById('buque-nombre').value,
    document.getElementById('buque-eta').value,
    document.getElementById('buque-nor').value,
    document.getElementById('buque-rata').value,
    document.getElementById('buque-condicion').value,
    document.getElementById('buque-tm').value,
    document.getElementById('inicio-op').value,
    document.getElementById('fin-op').value,
    document.getElementById('laytime').innerText,
    document.getElementById('tiempo-operacion').innerText
  ]];
  const wsInfo = XLSX.utils.aoa_to_sheet(infoGeneral);
  XLSX.utils.book_append_sheet(wb, wsInfo, 'Informaci√≥n General');
  
  // Hoja 2: Productos
  const productosData = [['Producto', 'Bodega', 'Declarado (TM)', 'Descargado (TM)', 'Usuario']];
  productos.forEach(p => productosData.push([p.tipo, p.bodega, p.declarado, p.descargado, p.usuario || '']));
  const wsProductos = XLSX.utils.aoa_to_sheet(productosData);
  XLSX.utils.book_append_sheet(wb, wsProductos, 'Productos');
  
  // Hoja 3: Paradas
  const paradasData = [['Motivo', 'Bodega', 'Inicio', 'Fin', 'Duraci√≥n (h)', 'Usuario']];
  paradas.forEach(p => {
    let duracion = 0;
    if(p.ini && p.fin) {
      duracion = ((new Date(p.fin) - new Date(p.ini)) / 3600000).toFixed(2);
    }
    paradasData.push([p.motivo, p.bodega, p.ini, p.fin, duracion, p.usuario || '']);
  });
  const wsParadas = XLSX.utils.aoa_to_sheet(paradasData);
  XLSX.utils.book_append_sheet(wb, wsParadas, 'Paradas');
  
  // Hoja 4: Camiones
  const camionesData = [['No. Listado', 'Placa', 'Ficha', 'Estatus', 'Usuario']];
  camiones.forEach(c => camionesData.push([c.nlist, c.placa, c.ficha, c.estatus, c.usuario || '']));
  const wsCamiones = XLSX.utils.aoa_to_sheet(camionesData);
  XLSX.utils.book_append_sheet(wb, wsCamiones, 'Camiones');
  
  // Hoja 5: Correa
  const correaData = [['L√≠nea', 'Producto', 'Toneladas', 'Hora', 'Usuario']];
  correa.forEach(c => correaData.push([c.linea, c.prod, c.tn, c.hora, c.usuario || '']));
  const wsCorrea = XLSX.utils.aoa_to_sheet(correaData);
  XLSX.utils.book_append_sheet(wb, wsCorrea, 'Correa Mecanizada');
  
  // Hoja 6: Mecanizado
  const mecData = [['Producto', 'Toneladas', 'Hora', 'Usuario']];
  mecanizado.forEach(m => mecData.push([m.producto, m.tn, m.hora, m.usuario || '']));
  const wsMec = XLSX.utils.aoa_to_sheet(mecData);
  XLSX.utils.book_append_sheet(wb, wsMec, 'Mecanizado');
  
  // Hoja 7: Dashboard
  const dashData = [
    ['M√©trica', 'Valor'],
    ['Descarga Cami√≥n (TM)', document.getElementById('dsh-tot-camion').innerText],
    ['Descarga Mecanizado (TM)', document.getElementById('dsh-tot-mec').innerText],
    ['Total Global (TM)', document.getElementById('dsh-tot-total').innerText],
    ['Tiempo Bruto (h)', document.getElementById('dsh-tiempo-bruto').innerText],
    ['Tiempo Neto (h)', document.getElementById('dsh-tiempo-neto').innerText],
    ['TPH Promedio', document.getElementById('dsh-tph').innerText],
    ['Laytime Restante (h)', document.getElementById('dsh-laytime-rest').innerText]
  ];
  const wsDash = XLSX.utils.aoa_to_sheet(dashData);
  XLSX.utils.book_append_sheet(wb, wsDash, 'Dashboard');
  
  const fecha = new Date().toISOString().split('T')[0];
  XLSX.writeFile(wb, `Trazabilidad_Buques_Completo_${fecha}.xlsx`);
}

function exportarSeccion(seccion) {
  const wb = XLSX.utils.book_new();
  let data = [];
  let nombre = '';
  
  switch(seccion) {
    case 'info-general':
      nombre = 'Informaci√≥n General';
      data = [[
        'Nombre Buque', 'ETA', 'Fecha NOR', 'Rata Contratada', 'Condici√≥n', 
        'Total Producto (TM)', 'Inicio Operaci√≥n', 'Fin Operaci√≥n', 'Laytime', 'Tiempo Operaci√≥n'
      ], [
        document.getElementById('buque-nombre').value,
        document.getElementById('buque-eta').value,
        document.getElementById('buque-nor').value,
        document.getElementById('buque-rata').value,
        document.getElementById('buque-condicion').value,
        document.getElementById('buque-tm').value,
        document.getElementById('inicio-op').value,
        document.getElementById('fin-op').value,
        document.getElementById('laytime').innerText,
        document.getElementById('tiempo-operacion').innerText
      ]];
      break;
    case 'productos':
      nombre = 'Productos';
      data = [['Producto', 'Bodega', 'Declarado (TM)', 'Descargado (TM)', 'Usuario']];
      productos.forEach(p => data.push([p.tipo, p.bodega, p.declarado, p.descargado, p.usuario || '']));
      break;
    case 'paradas':
      nombre = 'Paradas';
      data = [['Motivo', 'Bodega', 'Inicio', 'Fin', 'Duraci√≥n (h)', 'Usuario']];
      paradas.forEach(p => {
        let duracion = 0;
        if(p.ini && p.fin) {
          duracion = ((new Date(p.fin) - new Date(p.ini)) / 3600000).toFixed(2);
        }
        data.push([p.motivo, p.bodega, p.ini, p.fin, duracion, p.usuario || '']);
      });
      break;
    case 'camiones':
      nombre = 'Camiones';
      data = [['No. Listado', 'Placa', 'Ficha', 'Estatus', 'Usuario']];
      camiones.forEach(c => data.push([c.nlist, c.placa, c.ficha, c.estatus, c.usuario || '']));
      break;
    case 'correa':
      nombre = 'Correa';
      data = [['L√≠nea', 'Producto', 'Toneladas', 'Hora', 'Usuario']];
      correa.forEach(c => data.push([c.linea, c.prod, c.tn, c.hora, c.usuario || '']));
      break;
    case 'toneladas':
      nombre = 'Mecanizado';
      data = [['Producto', 'Toneladas', 'Hora', 'Usuario']];
      mecanizado.forEach(m => data.push([m.producto, m.tn, m.hora, m.usuario || '']));
      break;
    case 'dashboard':
      nombre = 'Dashboard';
      data = [
        ['M√©trica', 'Valor'],
        ['Descarga Cami√≥n (TM)', document.getElementById('dsh-tot-camion').innerText],
        ['Descarga Mecanizado (TM)', document.getElementById('dsh-tot-mec').innerText],
        ['Total Global (TM)', document.getElementById('dsh-tot-total').innerText],
        ['Tiempo Bruto (h)', document.getElementById('dsh-tiempo-bruto').innerText],
        ['Tiempo Neto (h)', document.getElementById('dsh-tiempo-neto').innerText],
        ['TPH Promedio', document.getElementById('dsh-tph').innerText],
        ['Laytime Restante (h)', document.getElementById('dsh-laytime-rest').innerText]
      ];
      break;
  }
  
  const ws = XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, nombre);
  
  const fecha = new Date().toISOString().split('T')[0];
  XLSX.writeFile(wb, `${nombre}_${fecha}.xlsx`);
}

// ==== LAYTIME Y OPERACI√ìN ====
function calcLaytime() {
  const tm = parseFloat(document.getElementById('buque-tm').value) || 0;
  const rata = parseFloat(document.getElementById('buque-rata').value) || 0;
  const condicion = document.getElementById('buque-condicion').value;
  if (tm > 0 && rata > 0) {
    let dias = tm / rata;
    if (condicion === 'SHEX') dias *= 7 / 5;
    laytimeHoras = Math.round(dias * 24);
  } else {
    laytimeHoras = 0;
  }
  ajustarLaytimeLluvia();
  guardarDatos();
}

['buque-tm', 'buque-rata', 'buque-condicion', 'buque-nombre', 'buque-eta', 'buque-nor'].forEach((id) => {
  document.getElementById(id).addEventListener('input', calcLaytime);
});

function ajustarLaytimeLluvia() {
  tiempoLluvia = paradas
    .filter((p) => p.motivo === 'LLUVIA' && p.ini && p.fin)
    .reduce((a, p) => a + (new Date(p.fin) - new Date(p.ini)) / 3600000, 0);
  laytimeAdjusted = Math.round((laytimeHoras + tiempoLluvia) * 100) / 100;
  document.getElementById('laytime').innerText = (laytimeAdjusted || 0) + ' horas';
}

function calcOperacion() {
  const ini = document.getElementById('inicio-op').value;
  const fin = document.getElementById('fin-op').value;
  if (!ini) {
    document.getElementById('tiempo-operacion').innerText = 'No iniciado';
    return 0;
  }
  const dtIni = new Date(ini);
  let dtFin = fin ? new Date(fin) : new Date();
  let diff = Math.max((dtFin - dtIni) / 3600000, 0);
  document.getElementById('tiempo-operacion').innerText = diff.toFixed(2) + ' h';
  tiempoBruto = diff;

  tiempoParadas = paradas
    .filter((p) => p.motivo !== 'LLUVIA' && p.ini && p.fin)
    .reduce((a, p) => a + (new Date(p.fin) - new Date(p.ini)) / 3600000, 0);
  return diff;
}

['inicio-op', 'fin-op'].forEach((id) => {
  document.getElementById(id).addEventListener('input', () => {
    calcOperacion();
    updateDashboard();
    guardarDatos();
  });
});

// ==== PRODUCTOS ====
function renderProductos() {
  const tbody = document.getElementById('tbody-productos');
  tbody.innerHTML = '';
  productos.forEach((p, i) => {
    tbody.innerHTML += `<tr>
      <td>${p.tipo || ''}</td>
      <td>${p.bodega || ''}</td>
      <td><input type='number' min='0' style='width:70px' value='${p.declarado}' onchange='actProdDeclarado(${i}, this.value)'></td>
      <td><input type='number' min='0' style='width:70px' value='${p.descargado}' onchange='actProdDescargado(${i}, this.value)'></td>
      <td><span class="user-badge">${p.usuario || ''}</span></td>
      <td><button type="button" onclick="eliminaProducto(${i})"><i class="fa fa-trash"></i></button></td>
    </tr>`;
  });
}

function actProdDeclarado(idx, vl) {
  productos[idx].declarado = Number(vl);
  productos[idx].usuario = currentUsername;
  renderProductos();
  updateDashboard();
  guardarDatos();
}

function actProdDescargado(idx, vl) {
  productos[idx].descargado = Number(vl);
  productos[idx].usuario = currentUsername;
  renderProductos();
  updateDashboard();
  guardarDatos();
}

function agregarProducto() {
  const tipo = document.getElementById('nuevo-producto-tipo').value;
  const bodega = document.getElementById('nuevo-producto-bodega').value;
  if (!tipo || !bodega) {
    alert('Debe seleccionar producto y bodega');
    return;
  }
  productos.push({ tipo: tipo, bodega: bodega, declarado: 0, descargado: 0, usuario: currentUsername });
  renderProductos();
  updateDashboard();
  guardarDatos();
  document.getElementById('nuevo-producto-tipo').value = '';
  document.getElementById('nuevo-producto-bodega').value = '';
}

function eliminaProducto(idx) {
  if(confirm('¬øEliminar este producto?')) {
    productos.splice(idx, 1);
    renderProductos();
    updateDashboard();
    guardarDatos();
  }
}

// ==== PARADAS ====
function registrarParada(e) {
  e.preventDefault();
  let motivo = document.getElementById('parada-motivo').value;
  let bodega = document.getElementById('bodega-afectada').value;
  let ini = document.getElementById('parada-inicio').value;
  let fin = document.getElementById('parada-fin').value;
  
  paradas.push({ motivo, bodega, ini, fin, usuario: currentUsername });
  renderParadas();
  ajustarLaytimeLluvia();
  updateDashboard();
  guardarDatos();
  e.target.reset();
  return false;
}

function renderParadas() {
  const tbody = document.getElementById('tbody-paradas');
  tbody.innerHTML = '';
  paradas.forEach((p, i) => {
    let duration = '', diff = 0;
    if (p.ini && p.fin) {
      const d1 = new Date(p.ini), d2 = new Date(p.fin);
      diff = (d2 - d1) / 3600000;
      duration = `${Math.floor(diff)}h ${Math.round((diff % 1) * 60)}m`;
    }
    tbody.innerHTML += `<tr>
      <td>${p.motivo}</td>
      <td>${p.bodega}</td>
      <td>${p.ini.replace('T', ' ')}</td>
      <td>${p.fin.replace('T', ' ')}</td>
      <td>${duration}</td>
      <td><span class="user-badge">${p.usuario || ''}</span></td>
      <td><button type="button" onclick="eliminaParada(${i})"><i class="fa fa-trash"></i></button></td>
    </tr>`;
  });
  let total = 0;
  paradas.forEach((p) => {
    if (p.ini && p.fin) total += (new Date(p.fin) - new Date(p.ini)) / 3600000;
  });
  document.getElementById('tiempo-paradas').innerText = total.toFixed(2) + ' h';
}

function eliminaParada(idx) {
  if(confirm('¬øEliminar esta parada?')) {
    paradas.splice(idx, 1);
    renderParadas();
    ajustarLaytimeLluvia();
    updateDashboard();
    guardarDatos();
  }
}

// ==== CAMIONES ====
function registrarCamion(e) {
  e.preventDefault();
  let nlist = document.getElementById('camion-nlistado').value;
  let placa = document.getElementById('camion-placa').value;
  let ficha = document.getElementById('camion-ficha').value;
  let estatus = document.getElementById('camion-estatus').value;
  
  if (camiones.find((c) => c.nlist === nlist && (c.placa === placa || c.ficha === ficha))) {
    alert('Ya existe esa ficha o placa en ese listado');
    return false;
  }
  camiones.push({ nlist, placa, ficha, estatus, usuario: currentUsername });
  renderCamiones();
  guardarDatos();
  e.target.reset();
  return false;
}

function renderCamiones() {
  const tbody = document.getElementById('tbody-camiones');
  tbody.innerHTML = '';
  let filtro = document.getElementById('filtro-estatus').value;
  let visibles = camiones.filter((c) => filtro === 'Todos' ? true : c.estatus === filtro);
  
  visibles.forEach((c, i) => {
    let icon = c.estatus === 'Cargado' ? 'fa-check-circle' : 'fa-times-circle';
    let idx = camiones.indexOf(c);
    tbody.innerHTML += `<tr>
      <td>${c.nlist}</td>
      <td>${c.placa}</td>
      <td>${c.ficha}</td>
      <td><span class="status-badge ${c.estatus === 'Cargado' ? 'cargado' : 'no-cargado'}"><i class="fa ${icon}"></i> ${c.estatus}</span></td>
      <td><span class="user-badge">${c.usuario || ''}</span></td>
      <td><button type="button" onclick="eliminaCamion(${idx})"><i class="fa fa-trash"></i></button></td>
    </tr>`;
  });
  document.getElementById('camion-total').innerText = camiones.length;
  let operacionHoras = calcOperacion() || 1;
  document.getElementById('camion-xhora').innerText = (camiones.length / Math.max(operacionHoras / 24, 0.1)).toFixed(1);
}

function eliminaCamion(idx) {
  if(confirm('¬øEliminar este cami√≥n?')) {
    camiones.splice(idx, 1);
    renderCamiones();
    guardarDatos();
  }
}

function filtrarCamiones() {
  renderCamiones();
}

// ==== CORREA MECANIZADA ====
function registrarCorrea(e) {
  e.preventDefault();
  let linea = document.getElementById('correa-linea').value;
  let prod = document.getElementById('correa-producto').value;
  let tn = document.getElementById('correa-tn').value;
  let hora = document.getElementById('correa-hora').value;
  
  correa.push({ linea, prod, tn: Number(tn), hora, usuario: currentUsername });
  renderCorrea();
  updateDashboard();
  guardarDatos();
  e.target.reset();
  return false;
}

function renderCorrea() {
  const tbody = document.getElementById('tbody-correa');
  tbody.innerHTML = '';
  correa.forEach((c, i) => {
    tbody.innerHTML += `<tr>
      <td>${c.linea}</td>
      <td>${c.prod}</td>
      <td>${c.tn}</td>
      <td>${c.hora.replace('T', ' ')}</td>
      <td><span class="user-badge">${c.usuario || ''}</span></td>
      <td><button type="button" onclick="eliminaCorrea(${i})"><i class="fa fa-trash"></i></button></td>
    </tr>`;
  });
  let total = correa.reduce((acc, c) => acc + c.tn, 0);
  document.getElementById('total-correa').innerText = total.toFixed(2);
}

function eliminaCorrea(idx) {
  if(confirm('¬øEliminar este registro?')) {
    correa.splice(idx, 1);
    renderCorrea();
    updateDashboard();
    guardarDatos();
  }
}

// ==== MECANIZADO ====
function agregarLineaMec(e) {
  e.preventDefault();
  mecanizado.push({
    producto: document.getElementById('mec-producto').value,
    tn: Number(document.getElementById('mec-tn').value),
    hora: document.getElementById('mec-hora').value,
    usuario: currentUsername
  });
  renderTablaMec();
  mostrarTonCamiones();
  guardarDatos();
  e.target.reset();
  return false;
}

function renderTablaMec() {
  const tb = document.querySelector('#tabla-mec tbody');
  tb.innerHTML = '';
  mecanizado.forEach((m, i) => {
    tb.innerHTML += `<tr>
      <td>${m.producto}</td>
      <td>${m.tn}</td>
      <td>${m.hora}</td>
      <td><span class="user-badge">${m.usuario || ''}</span></td>
      <td><button type="button" onclick="eliminaMec(${i})"><i class="fa fa-trash"></i></button></td>
    </tr>`;
  });
  document.getElementById('total-mec').innerText = mecanizado.reduce((a, b) => a + b.tn, 0).toFixed(2);
}

function eliminaMec(idx) {
  if(confirm('¬øEliminar esta l√≠nea?')) {
    mecanizado.splice(idx, 1);
    renderTablaMec();
    mostrarTonCamiones();
    guardarDatos();
  }
}

// ==== IMPORTAR TONELADAS CAMIONES ====
document.getElementById('import-camiones').addEventListener('change', function (evt) {
  const file = evt.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function (e) {
    try {
      const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
      const name = workbook.SheetNames[0];
      const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[name], { header: 1, defval: '' });
      procesarTonCamiones(sheet);
    } catch(err) {
      alert('Error al leer el archivo: ' + err.message);
    }
  };
  reader.readAsArrayBuffer(file);
});

function procesarTonCamiones(sheet) {
  let headerIdx = sheet.findIndex((row) =>
    row.includes('Fecha Entrada') && row.includes('Producto') && row.includes('Peso Neto (t)')
  );
  if (headerIdx == -1) {
    document.getElementById('res-ton-camiones').innerHTML = 'No se detectan encabezados v√°lidos.';
    return;
  }
  let header = sheet[headerIdx];
  let idxFecha = header.findIndex((h) => h === 'Fecha Entrada');
  let idxProd = header.findIndex((h) => h === 'Producto');
  let idxPeso = header.findIndex((h) => h === 'Peso Neto (t)');
  let tabla = [];
  for (let i = headerIdx + 1; i < sheet.length; i++) {
    let row = sheet[i];
    if (!row[idxProd] || isNaN(parseFloat(row[idxPeso]))) continue;
    tabla.push({
      producto: row[idxProd],
      peso: parseFloat(row[idxPeso]),
      fecha: row[idxFecha],
    });
  }
  dataImport = tabla;
  mostrarTonCamiones();
}

function limpiarTonCamiones() {
  dataImport = [];
  horas = [];
  dataResumen = {};
  document.getElementById('res-ton-camiones').innerHTML = '';
  const ctx = document.getElementById('grafico-ton').getContext('2d');
  ctx.clearRect(0, 0, 950, 140);
  updateDashboard();
}

function mostrarTonCamiones() {
  let resumen = {}, resumenHora = {}, horasV = [];
  dataImport.forEach((r) => {
    let prod = r.producto, peso = r.peso;
    let hora = r.fecha && r.fecha.split(' ')[1] ? r.fecha.split(' ')[1].substring(0, 5) : '';
    resumen[prod] = (resumen[prod] || 0) + peso;
    if (!resumenHora[hora]) resumenHora[hora] = {};
    resumenHora[hora][prod] = (resumenHora[hora][prod] || 0) + peso;
    if (hora && !horasV.includes(hora)) horasV.push(hora);
  });
  
  let resumenMec = {}, resumenHoraMec = {};
  mecanizado.forEach((m) => {
    resumenMec[m.producto] = (resumenMec[m.producto] || 0) + m.tn;
    if (!resumenHoraMec[m.hora]) resumenHoraMec[m.hora] = {};
    resumenHoraMec[m.hora][m.producto] = (resumenHoraMec[m.hora][m.producto] || 0) + m.tn;
    if (m.hora && !horasV.includes(m.hora)) horasV.push(m.hora);
  });
  
  horasV = horasV.sort();
  dataResumen = resumen;
  horas = horasV;
  
  let html = '<table><thead><tr><th>Producto</th><th>Cami√≥n</th><th>Mecanizado</th><th>Total</th></tr></thead><tbody>';
  let sumaCamion = 0, sumaMec = 0;
  let todosProds = Array.from(new Set([...Object.keys(resumen), ...Object.keys(resumenMec)]));
  
  todosProds.forEach((prod) => {
    let valC = resumen[prod] || 0;
    let valM = resumenMec[prod] || 0;
    let ttl = valC + valM;
    sumaCamion += valC;
    sumaMec += valM;
    html += `<tr><td>${prod}</td><td>${valC.toFixed(2)}</td><td>${valM.toFixed(2)}</td><td>${ttl.toFixed(2)}</td></tr>`;
  });
  
  html += '</tbody></table><div style="margin-top:10px"><b>Total cami√≥n:</b> ' + sumaCamion.toFixed(2) + ' TM<br><b>Total mecanizado:</b> ' + sumaMec.toFixed(2) + ' TM<br><b>Total conjunto:</b> ' + (sumaCamion + sumaMec).toFixed(2) + ' TM</div>';
  document.getElementById('res-ton-camiones').innerHTML = html;
  document.getElementById('total-mec').innerText = sumaMec.toFixed(2);
  
  ultimoResumenGlobal = { tc: sumaCamion, tm: sumaMec, total: sumaCamion + sumaMec };
  updateDashboard();
  graficarTonCamiones(resumenHora, resumenHoraMec, horasV);
}

let ultimoResumenGlobal = { tc: 0, tm: 0, total: 0 };

function updateDashboard() {
  document.getElementById('dsh-tot-camion').innerText = ultimoResumenGlobal.tc.toFixed(2) + ' TM';
  document.getElementById('dsh-tot-mec').innerText = ultimoResumenGlobal.tm.toFixed(2) + ' TM';
  document.getElementById('dsh-tot-total').innerText = ultimoResumenGlobal.total.toFixed(2) + ' TM';
  
  calcOperacion();
  let neto = Math.max(tiempoBruto - tiempoParadas, 0);
  document.getElementById('dsh-tiempo-bruto').innerText = tiempoBruto.toFixed(2) + ' h';
  document.getElementById('dsh-tiempo-neto').innerText = neto.toFixed(2) + ' h';
  
  let tphBruto = tiempoBruto > 0 ? ultimoResumenGlobal.total / tiempoBruto : 0;
  let tphNeto = neto > 0 ? ultimoResumenGlobal.total / neto : 0;
  document.getElementById('dsh-tph').innerText = `${tphBruto.toFixed(1)} / ${tphNeto.toFixed(1)}`;
  
  let disponible = (laytimeAdjusted || 0) - (tiempoBruto || 0);
  document.getElementById('dsh-laytime-rest').innerText = (disponible > 0 ? disponible.toFixed(2) : '0') + ' h';
}

function graficarTonCamiones(objHoras, objHorasMec, horasV) {
  let ctx = document.getElementById('grafico-ton').getContext('2d');
  ctx.clearRect(0, 0, 950, 140);
  
  if(horasV.length === 0) return;
  
  let colors = ['#28568d', '#bda25f', '#e4183a'];
  
  horasV.forEach((hora, i) => {
    let suma = Object.values(objHoras[hora] || {}).reduce((a, b) => a + b, 0);
    let maxVal = Math.max(1, ...horasV.map((hh) => Object.values(objHoras[hh] || {}).reduce((a, b) => a + b, 0)));
    let x = 35 + i * 40;
    let y = 120 - (suma * 80) / maxVal;
    ctx.fillStyle = colors[0];
    ctx.fillRect(x, y, 15, 120 - y - 9);
  });
  
  horasV.forEach((hora, i) => {
    let suma = Object.values(objHorasMec[hora] || {}).reduce((a, b) => a + b, 0);
    let maxVal = Math.max(1, ...horasV.map((hh) => Object.values(objHorasMec[hh] || {}).reduce((a, b) => a + b, 0)));
    let x = 53 + i * 40;
    let y = 120 - (suma * 80) / maxVal;
    ctx.fillStyle = colors[1];
    ctx.fillRect(x, y, 15, 120 - y - 9);
  });
  
  ctx.beginPath();
  ctx.strokeStyle = colors[2];
  ctx.lineWidth = 2;
  horasV.forEach((hora, i) => {
    let sumaCam = Object.values(objHoras[hora] || {}).reduce((a, b) => a + b, 0);
    let sumaMec = Object.values(objHorasMec[hora] || {}).reduce((a, b) => a + b, 0);
    let sumaTotal = sumaCam + sumaMec;
    let maxTotal = Math.max(1, ...horasV.map((hh) => 
      Object.values(objHoras[hh] || {}).reduce((a, b) => a + b, 0) + Object.values(objHorasMec[hh] || {}).reduce((a, b) => a + b, 0)
    ));
    let y = 120 - (sumaTotal * 80) / maxTotal;
    let x = 43 + i * 40;
    if (i == 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.stroke();
  
  ctx.fillStyle = '#19324c';
  ctx.font = '11px Segoe UI';
  horasV.forEach((hora, i) => ctx.fillText(hora, 35 + i * 40, 134));
}

// Inicializaci√≥n
document.addEventListener('DOMContentLoaded', () => {
  renderProductos();
  renderParadas();
  renderCamiones();
  renderCorrea();
  renderTablaMec();
  updateDashboard();
  console.log('Sistema inicializado correctamente');
});

setInterval(updateDashboard, 30000);
</script>
</body>
</html>
